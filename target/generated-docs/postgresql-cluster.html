<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.2">
<title>PostgreSQL Cluster</title>
<style>
/*! normalize.css v2.1.2 | MIT License | git.io/normalize */
/* ========================================================================== HTML5 display definitions ========================================================================== */
/** Correct `block` display not defined in IE 8/9. */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary {
    display: block;
}

/** Correct `inline-block` display not defined in IE 8/9. */
audio, canvas, video {
    display: inline-block;
}

/** Prevent modern browsers from displaying `audio` without controls. Remove excess height in iOS 5 devices. */
audio:not([controls]) {
    display: none;
    height: 0;
}

/** Address `[hidden]` styling not present in IE 8/9. Hide the `template` element in IE, Safari, and Firefox < 22. */
[hidden], template {
    display: none;
}

script {
    display: none !important;
}

/* ========================================================================== Base ========================================================================== */
/** 1. Set default font family to sans-serif. 2. Prevent iOS text size adjust after orientation change, without disabling user zoom. */
html {
    font-family: sans-serif; /* 1 */
    -ms-text-size-adjust: 100%; /* 2 */
    -webkit-text-size-adjust: 100%; /* 2 */
}

/** Remove default margin. */
body {
    margin: 0;
}

/* ========================================================================== Links ========================================================================== */
/** Remove the gray background color from active links in IE 10. */
a {
    background: transparent;
}

/** Address `outline` inconsistency between Chrome and other browsers. */
a:focus {
    outline: thin dotted;
}

/** Improve readability when focused and also mouse hovered in all browsers. */
a:active, a:hover {
    outline: 0;
}

/* ========================================================================== Typography ========================================================================== */
/** Address variable `h1` font-size and margin within `section` and `article` contexts in Firefox 4+, Safari 5, and Chrome. */
h1 {
    font-size: 2em;
    margin: 0.67em 0;
}

/** Address styling not present in IE 8/9, Safari 5, and Chrome. */
abbr[title] {
    border-bottom: 1px dotted;
}

/** Address style set to `bolder` in Firefox 4+, Safari 5, and Chrome. */
b, strong {
    font-weight: bold;
}

/** Address styling not present in Safari 5 and Chrome. */
dfn {
    font-style: italic;
}

/** Address differences between Firefox and other browsers. */
hr {
    -moz-box-sizing: content-box;
    box-sizing: content-box;
    height: 0;
}

/** Address styling not present in IE 8/9. */
mark {
    background: #ff0;
    color: #000;
}

/** Correct font family set oddly in Safari 5 and Chrome. */
code, kbd, pre, samp {
    font-family: monospace, serif;
    font-size: 1em;
}

/** Improve readability of pre-formatted text in all browsers. */
pre {
    white-space: pre-wrap;
}

/** Set consistent quote types. */
q {
    quotes: "\201C" "\201D" "\2018" "\2019";
}

/** Address inconsistent and variable font size in all browsers. */
small {
    font-size: 80%;
}

/** Prevent `sub` and `sup` affecting `line-height` in all browsers. */
sub, sup {
    font-size: 75%;
    line-height: 0;
    position: relative;
    vertical-align: baseline;
}

sup {
    top: -0.5em;
}

sub {
    bottom: -0.25em;
}

/* ========================================================================== Embedded content ========================================================================== */
/** Remove border when inside `a` element in IE 8/9. */
img {
    border: 0;
}

/** Correct overflow displayed oddly in IE 9. */
svg:not(:root) {
    overflow: hidden;
}

/* ========================================================================== Figures ========================================================================== */
/** Address margin not present in IE 8/9 and Safari 5. */
figure {
    margin: 0;
}

/* ========================================================================== Forms ========================================================================== */
/** Define consistent border, margin, and padding. */
fieldset {
    border: 1px solid #c0c0c0;
    margin: 0 2px;
    padding: 0.35em 0.625em 0.75em;
}

/** 1. Correct `color` not being inherited in IE 8/9. 2. Remove padding so people aren't caught out if they zero out fieldsets. */
legend {
    border: 0; /* 1 */
    padding: 0; /* 2 */
}

/** 1. Correct font family not being inherited in all browsers. 2. Correct font size not being inherited in all browsers. 3. Address margins set differently in Firefox 4+, Safari 5, and Chrome. */
button, input, select, textarea {
    font-family: inherit; /* 1 */
    font-size: 100%; /* 2 */
    margin: 0; /* 3 */
}

/** Address Firefox 4+ setting `line-height` on `input` using `!important` in the UA stylesheet. */
button, input {
    line-height: normal;
}

/** Address inconsistent `text-transform` inheritance for `button` and `select`. All other form control elements do not inherit `text-transform` values. Correct `button` style inheritance in Chrome, Safari 5+, and IE 8+. Correct `select` style inheritance in Firefox 4+ and Opera. */
button, select {
    text-transform: none;
}

/** 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio` and `video` controls. 2. Correct inability to style clickable `input` types in iOS. 3. Improve usability and consistency of cursor style between image-type `input` and others. */
button, html input[type="button"], input[type="reset"], input[type="submit"] {
    -webkit-appearance: button; /* 2 */
    cursor: pointer; /* 3 */
}

/** Re-set default cursor for disabled elements. */
button[disabled], html input[disabled] {
    cursor: default;
}

/** 1. Address box sizing set to `content-box` in IE 8/9. 2. Remove excess padding in IE 8/9. */
input[type="checkbox"], input[type="radio"] {
    box-sizing: border-box; /* 1 */
    padding: 0; /* 2 */
}

/** 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome. 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome (include `-moz` to future-proof). */
input[type="search"] {
    -webkit-appearance: textfield; /* 1 */
    -moz-box-sizing: content-box;
    -webkit-box-sizing: content-box; /* 2 */
    box-sizing: content-box;
}

/** Remove inner padding and search cancel button in Safari 5 and Chrome on OS X. */
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration {
    -webkit-appearance: none;
}

/** Remove inner padding and border in Firefox 4+. */
button::-moz-focus-inner, input::-moz-focus-inner {
    border: 0;
    padding: 0;
}

/** 1. Remove default vertical scrollbar in IE 8/9. 2. Improve readability and alignment in all browsers. */
textarea {
    overflow: auto; /* 1 */
    vertical-align: top; /* 2 */
}

/* ========================================================================== Tables ========================================================================== */
/** Remove most spacing between table cells. */
table {
    border-collapse: collapse;
    border-spacing: 0;
}

meta.foundation-mq-small {
    font-family: "only screen and (min-width: 768px)";
    width: 768px;
}

meta.foundation-mq-medium {
    font-family: "only screen and (min-width:1280px)";
    width: 1280px;
}

meta.foundation-mq-large {
    font-family: "only screen and (min-width:1440px)";
    width: 1440px;
}

*, *:before, *:after {
    -moz-box-sizing: border-box;
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
}

html, body {
    font-size: 100%;
}

body {
    background: white;
    color: rgba(0, 0, 0, 0.8);
    padding: 0;
    margin: 0;
    font-family: "Noto Serif", "DejaVu Serif", serif;
    font-weight: normal;
    font-style: normal;
    line-height: 1;
    position: relative;
    cursor: auto;
}

a:hover {
    cursor: pointer;
}

img, object, embed {
    max-width: 100%;
    height: auto;
}

object, embed {
    height: 100%;
}

img {
    -ms-interpolation-mode: bicubic;
}

#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object {
    max-width: none !important;
}

.left {
    float: left !important;
}

.right {
    float: right !important;
}

.text-left {
    text-align: left !important;
}

.text-right {
    text-align: right !important;
}

.text-center {
    text-align: center !important;
}

.text-justify {
    text-align: justify !important;
}

.hide {
    display: none;
}

.antialiased, body {
    -webkit-font-smoothing: antialiased;
}

img {
    display: inline-block;
    vertical-align: middle;
}

textarea {
    height: auto;
    min-height: 50px;
}

select {
    width: 100%;
}

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p {
    font-size: 1.21875em;
    line-height: 1.6;
}

.subheader, .admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title {
    line-height: 1.45;
    color: #7a2518;
    font-weight: normal;
    margin-top: 0;
    margin-bottom: 0.25em;
}

/* Typography resets */
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td {
    margin: 0;
    padding: 0;
    direction: ltr;
}

/* Default Link Styles */
a {
    color: #2156a5;
    text-decoration: underline;
    line-height: inherit;
}

a:hover, a:focus {
    color: #1d4b8f;
}

a img {
    border: none;
}

/* Default paragraph styles */
p {
    font-family: inherit;
    font-weight: normal;
    font-size: 1em;
    line-height: 1.6;
    margin-bottom: 1.25em;
    text-rendering: optimizeLegibility;
}

p aside {
    font-size: 0.875em;
    line-height: 1.35;
    font-style: italic;
}

/* Default header styles */
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 {
    font-family: "Open Sans", "DejaVu Sans", sans-serif;
    font-weight: 300;
    font-style: normal;
    color: #ba3925;
    text-rendering: optimizeLegibility;
    margin-top: 1em;
    margin-bottom: 0.5em;
    line-height: 1.0125em;
}

h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small {
    font-size: 60%;
    color: #e99b8f;
    line-height: 0;
}

h1 {
    font-size: 2.125em;
}

h2 {
    font-size: 1.6875em;
}

h3, #toctitle, .sidebarblock > .content > .title {
    font-size: 1.375em;
}

h4 {
    font-size: 1.125em;
}

h5 {
    font-size: 1.125em;
}

h6 {
    font-size: 1em;
}

hr {
    border: solid #ddddd8;
    border-width: 1px 0 0;
    clear: both;
    margin: 1.25em 0 1.1875em;
    height: 0;
}

/* Helpful Typography Defaults */
em, i {
    font-style: italic;
    line-height: inherit;
}

strong, b {
    font-weight: bold;
    line-height: inherit;
}

small {
    font-size: 60%;
    line-height: inherit;
}

code {
    font-family: "Droid Sans Mono", "DejaVu Sans Mono", monospace;
    font-weight: normal;
    color: rgba(0, 0, 0, 0.9);
}

/* Lists */
ul, ol, dl {
    font-size: 1em;
    line-height: 1.6;
    margin-bottom: 1.25em;
    list-style-position: outside;
    font-family: inherit;
}

ul, ol {
    margin-left: 1.5em;
}

ul.no-bullet, ol.no-bullet {
    margin-left: 1.5em;
}

/* Unordered Lists */
ul li ul, ul li ol {
    margin-left: 1.25em;
    margin-bottom: 0;
    font-size: 1em; /* Override nested font-size change */
}

ul.square li ul, ul.circle li ul, ul.disc li ul {
    list-style: inherit;
}

ul.square {
    list-style-type: square;
}

ul.circle {
    list-style-type: circle;
}

ul.disc {
    list-style-type: disc;
}

ul.no-bullet {
    list-style: none;
}

/* Ordered Lists */
ol li ul, ol li ol {
    margin-left: 1.25em;
    margin-bottom: 0;
}

/* Definition Lists */
dl dt {
    margin-bottom: 0.3125em;
    font-weight: bold;
}

dl dd {
    margin-bottom: 1.25em;
}

/* Abbreviations */
abbr, acronym {
    text-transform: uppercase;
    font-size: 90%;
    color: rgba(0, 0, 0, 0.8);
    border-bottom: 1px dotted #dddddd;
    cursor: help;
}

abbr {
    text-transform: none;
}

/* Blockquotes */
blockquote {
    margin: 0 0 1.25em;
    padding: 0.5625em 1.25em 0 1.1875em;
    border-left: 1px solid #dddddd;
}

blockquote cite {
    display: block;
    font-size: 0.9375em;
    color: rgba(0, 0, 0, 0.6);
}

blockquote cite:before {
    content: "\2014 \0020";
}

blockquote cite a, blockquote cite a:visited {
    color: rgba(0, 0, 0, 0.6);
}

blockquote, blockquote p {
    line-height: 1.6;
    color: rgba(0, 0, 0, 0.85);
}

/* Microformats */
.vcard {
    display: inline-block;
    margin: 0 0 1.25em 0;
    border: 1px solid #dddddd;
    padding: 0.625em 0.75em;
}

.vcard li {
    margin: 0;
    display: block;
}

.vcard .fn {
    font-weight: bold;
    font-size: 0.9375em;
}

.vevent .summary {
    font-weight: bold;
}

.vevent abbr {
    cursor: auto;
    text-decoration: none;
    font-weight: bold;
    border: none;
    padding: 0 0.0625em;
}

@media only screen and (min-width: 768px) {
    h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 {
        line-height: 1.2;
    }

    h1 {
        font-size: 2.75em;
    }

    h2 {
        font-size: 2.3125em;
    }

    h3, #toctitle, .sidebarblock > .content > .title {
        font-size: 1.6875em;
    }

    h4 {
        font-size: 1.4375em;
    }
}

/* Tables */
table {
    background: white;
    margin-bottom: 1.25em;
    border: solid 1px #dedede;
}

table thead, table tfoot {
    background: #f7f8f7;
    font-weight: bold;
}

table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td {
    padding: 0.5em 0.625em 0.625em;
    font-size: inherit;
    color: rgba(0, 0, 0, 0.8);
    text-align: left;
}

table tr th, table tr td {
    padding: 0.5625em 0.625em;
    font-size: inherit;
    color: rgba(0, 0, 0, 0.8);
}

table tr.even, table tr.alt, table tr:nth-of-type(even) {
    background: #f8f8f7;
}

table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td {
    display: table-cell;
    line-height: 1.6;
}

h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 {
    line-height: 1.2;
    word-spacing: -0.05em;
}

h1 strong, h2 strong, h3 strong, #toctitle strong, .sidebarblock > .content > .title strong, h4 strong, h5 strong, h6 strong {
    font-weight: 400;
}

.clearfix:before, .clearfix:after, .float-group:before, .float-group:after {
    content: " ";
    display: table;
}

.clearfix:after, .float-group:after {
    clear: both;
}

*:not(pre) > code {
    font-size: 0.9375em;
    font-style: normal !important;
    letter-spacing: 0;
    padding: 0.1em 0.5ex;
    word-spacing: -0.15em;
    background-color: #f7f7f8;
    -webkit-border-radius: 4px;
    border-radius: 4px;
    line-height: 1.45;
    text-rendering: optimizeSpeed;
}

pre, pre > code {
    line-height: 1.45;
    color: rgba(0, 0, 0, 0.9);
    font-family: "Droid Sans Mono", "DejaVu Sans Mono", "Monospace", monospace;
    font-weight: normal;
    text-rendering: optimizeSpeed;
}

.keyseq {
    color: rgba(51, 51, 51, 0.8);
}

kbd {
    display: inline-block;
    color: rgba(0, 0, 0, 0.8);
    font-size: 0.75em;
    line-height: 1.4;
    background-color: #f7f7f7;
    border: 1px solid #ccc;
    -webkit-border-radius: 3px;
    border-radius: 3px;
    -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset;
    box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset;
    margin: -0.15em 0.15em 0 0.15em;
    padding: 0.2em 0.6em 0.2em 0.5em;
    vertical-align: middle;
    white-space: nowrap;
}

.keyseq kbd:first-child {
    margin-left: 0;
}

.keyseq kbd:last-child {
    margin-right: 0;
}

.menuseq, .menu {
    color: rgba(0, 0, 0, 0.8);
}

b.button:before, b.button:after {
    position: relative;
    top: -1px;
    font-weight: normal;
}

b.button:before {
    content: "[";
    padding: 0 3px 0 2px;
}

b.button:after {
    content: "]";
    padding: 0 2px 0 3px;
}

p a > code:hover {
    color: rgba(0, 0, 0, 0.9);
}

#header, #content, #footnotes, #footer {
    width: 100%;
    margin-left: auto;
    margin-right: auto;
    margin-top: 0;
    margin-bottom: 0;
    max-width: 62.5em;
    *zoom: 1;
    position: relative;
    padding-left: 0.9375em;
    padding-right: 0.9375em;
}

#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after {
    content: " ";
    display: table;
}

#header:after, #content:after, #footnotes:after, #footer:after {
    clear: both;
}

#content {
    margin-top: 1.25em;
}

#content:before {
    content: none;
}

#header > h1:first-child {
    color: rgba(0, 0, 0, 0.85);
    margin-top: 2.25rem;
    margin-bottom: 0;
}

#header > h1:first-child + #toc {
    margin-top: 8px;
    border-top: 1px solid #ddddd8;
}

#header > h1:only-child, body.toc2 #header > h1:nth-last-child(2) {
    border-bottom: 1px solid #ddddd8;
    padding-bottom: 8px;
}

#header .details {
    border-bottom: 1px solid #ddddd8;
    line-height: 1.45;
    padding-top: 0.25em;
    padding-bottom: 0.25em;
    padding-left: 0.25em;
    color: rgba(0, 0, 0, 0.6);
    display: -ms-flexbox;
    display: -webkit-flex;
    display: flex;
    -ms-flex-flow: row wrap;
    -webkit-flex-flow: row wrap;
    flex-flow: row wrap;
}

#header .details span:first-child {
    margin-left: -0.125em;
}

#header .details span.email a {
    color: rgba(0, 0, 0, 0.85);
}

#header .details br {
    display: none;
}

#header .details br + span:before {
    content: "\00a0\2013\00a0";
}

#header .details br + span.author:before {
    content: "\00a0\22c5\00a0";
    color: rgba(0, 0, 0, 0.85);
}

#header .details br + span#revremark:before {
    content: "\00a0|\00a0";
}

#header #revnumber {
    text-transform: capitalize;
}

#header #revnumber:after {
    content: "\00a0";
}

#content > h1:first-child:not([class]) {
    color: rgba(0, 0, 0, 0.85);
    border-bottom: 1px solid #ddddd8;
    padding-bottom: 8px;
    margin-top: 0;
    padding-top: 1rem;
    margin-bottom: 1.25rem;
}

#toc {
    border-bottom: 1px solid #efefed;
    padding-bottom: 0.5em;
}

#toc > ul {
    margin-left: 0.125em;
}

#toc ul.sectlevel0 > li > a {
    font-style: italic;
}

#toc ul.sectlevel0 ul.sectlevel1 {
    margin: 0.5em 0;
}

#toc ul {
    font-family: "Open Sans", "DejaVu Sans", sans-serif;
    list-style-type: none;
}

#toc a {
    text-decoration: none;
}

#toc a:active {
    text-decoration: underline;
}

#toctitle {
    color: #7a2518;
    font-size: 1.2em;
}

@media only screen and (min-width: 768px) {
    #toctitle {
        font-size: 1.375em;
    }

    body.toc2 {
        padding-left: 15em;
        padding-right: 0;
    }

    #toc.toc2 {
        margin-top: 0 !important;
        background-color: #f8f8f7;
        position: fixed;
        width: 15em;
        left: 0;
        top: 0;
        border-right: 1px solid #efefed;
        border-top-width: 0 !important;
        border-bottom-width: 0 !important;
        z-index: 1000;
        padding: 1.25em 1em;
        height: 100%;
        overflow: auto;
    }

    #toc.toc2 #toctitle {
        margin-top: 0;
        font-size: 1.2em;
    }

    #toc.toc2 > ul {
        font-size: 0.9em;
        margin-bottom: 0;
    }

    #toc.toc2 ul ul {
        margin-left: 0;
        padding-left: 1em;
    }

    #toc.toc2 ul.sectlevel0 ul.sectlevel1 {
        padding-left: 0;
        margin-top: 0.5em;
        margin-bottom: 0.5em;
    }

    body.toc2.toc-right {
        padding-left: 0;
        padding-right: 15em;
    }

    body.toc2.toc-right #toc.toc2 {
        border-right-width: 0;
        border-left: 1px solid #efefed;
        left: auto;
        right: 0;
    }
}

@media only screen and (min-width: 1280px) {
    body.toc2 {
        padding-left: 20em;
        padding-right: 0;
    }

    #toc.toc2 {
        width: 20em;
    }

    #toc.toc2 #toctitle {
        font-size: 1.375em;
    }

    #toc.toc2 > ul {
        font-size: 0.95em;
    }

    #toc.toc2 ul ul {
        padding-left: 1.25em;
    }

    body.toc2.toc-right {
        padding-left: 0;
        padding-right: 20em;
    }
}

#content #toc {
    border-style: solid;
    border-width: 1px;
    border-color: #e0e0dc;
    margin-bottom: 1.25em;
    padding: 1.25em;
    background: #f8f8f7;
    -webkit-border-radius: 4px;
    border-radius: 4px;
}

#content #toc > :first-child {
    margin-top: 0;
}

#content #toc > :last-child {
    margin-bottom: 0;
}

#footer {
    max-width: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    padding: 1.25em;
}

#footer-text {
    color: rgba(255, 255, 255, 0.8);
    line-height: 1.44;
}

.sect1 {
    padding-bottom: 0.625em;
}

@media only screen and (min-width: 768px) {
    .sect1 {
        padding-bottom: 1.25em;
    }
}

.sect1 + .sect1 {
    border-top: 1px solid #efefed;
}

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor {
    position: absolute;
    z-index: 1001;
    width: 1.5ex;
    margin-left: -1.5ex;
    display: block;
    text-decoration: none !important;
    visibility: hidden;
    text-align: center;
    font-weight: normal;
}

#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before {
    content: "\00A7";
    font-size: 0.85em;
    display: block;
    padding-top: 0.1em;
}

#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover {
    visibility: visible;
}

#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link {
    color: #ba3925;
    text-decoration: none;
}

#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover {
    color: #a53221;
}

.audioblock, .imageblock, .literalblock, .listingblock, .stemblock, .videoblock {
    margin-bottom: 1.25em;
}

.admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title {
    text-rendering: optimizeLegibility;
    text-align: left;
    font-family: "Noto Serif", "DejaVu Serif", serif;
    font-size: 1rem;
    font-style: italic;
}

table.tableblock > caption.title {
    white-space: nowrap;
    overflow: visible;
    max-width: 0;
}

.paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p {
    color: rgba(0, 0, 0, 0.85);
}

table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p {
    font-size: inherit;
}

.admonitionblock > table {
    border-collapse: separate;
    border: 0;
    background: none;
    width: 100%;
}

.admonitionblock > table td.icon {
    text-align: center;
    width: 80px;
}

.admonitionblock > table td.icon img {
    max-width: none;
}

.admonitionblock > table td.icon .title {
    font-weight: bold;
    font-family: "Open Sans", "DejaVu Sans", sans-serif;
    text-transform: uppercase;
}

.admonitionblock > table td.content {
    padding-left: 1.125em;
    padding-right: 1.25em;
    border-left: 1px solid #ddddd8;
    color: rgba(0, 0, 0, 0.6);
}

.admonitionblock > table td.content > :last-child > :last-child {
    margin-bottom: 0;
}

.exampleblock > .content {
    border-style: solid;
    border-width: 1px;
    border-color: #e6e6e6;
    margin-bottom: 1.25em;
    padding: 1.25em;
    background: white;
    -webkit-border-radius: 4px;
    border-radius: 4px;
}

.exampleblock > .content > :first-child {
    margin-top: 0;
}

.exampleblock > .content > :last-child {
    margin-bottom: 0;
}

.sidebarblock {
    border-style: solid;
    border-width: 1px;
    border-color: #e0e0dc;
    margin-bottom: 1.25em;
    padding: 1.25em;
    background: #f8f8f7;
    -webkit-border-radius: 4px;
    border-radius: 4px;
}

.sidebarblock > :first-child {
    margin-top: 0;
}

.sidebarblock > :last-child {
    margin-bottom: 0;
}

.sidebarblock > .content > .title {
    color: #7a2518;
    margin-top: 0;
    text-align: center;
}

.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child {
    margin-bottom: 0;
}

.literalblock pre, .listingblock pre:not(.highlight), .listingblock pre[class="highlight"], .listingblock pre[class^="highlight "], .listingblock pre.CodeRay, .listingblock pre.prettyprint {
    background: #f7f7f8;
}

.sidebarblock .literalblock pre, .sidebarblock .listingblock pre:not(.highlight), .sidebarblock .listingblock pre[class="highlight"], .sidebarblock .listingblock pre[class^="highlight "], .sidebarblock .listingblock pre.CodeRay, .sidebarblock .listingblock pre.prettyprint {
    background: #f2f1f1;
}

.literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] {
    -webkit-border-radius: 4px;
    border-radius: 4px;
    word-wrap: break-word;
    padding: 1em;
    font-size: 0.8125em;
}

.literalblock pre.nowrap, .literalblock pre[class].nowrap, .listingblock pre.nowrap, .listingblock pre[class].nowrap {
    overflow-x: auto;
    white-space: pre;
    word-wrap: normal;
}

@media only screen and (min-width: 768px) {
    .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] {
        font-size: 0.90625em;
    }
}

@media only screen and (min-width: 1280px) {
    .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] {
        font-size: 1em;
    }
}

.literalblock.output pre {
    color: #f7f7f8;
    background-color: rgba(0, 0, 0, 0.9);
}

.listingblock pre.highlightjs {
    padding: 0;
}

.listingblock pre.highlightjs > code {
    padding: 1em;
    -webkit-border-radius: 4px;
    border-radius: 4px;
}

.listingblock pre.prettyprint {
    border-width: 0;
}

.listingblock > .content {
    position: relative;
}

.listingblock code[data-lang]:before {
    display: none;
    content: attr(data-lang);
    position: absolute;
    font-size: 0.75em;
    top: 0.425rem;
    right: 0.5rem;
    line-height: 1;
    text-transform: uppercase;
    color: #999;
}

.listingblock:hover code[data-lang]:before {
    display: block;
}

.listingblock.terminal pre .command:before {
    content: attr(data-prompt);
    padding-right: 0.5em;
    color: #999;
}

.listingblock.terminal pre .command:not([data-prompt]):before {
    content: "$";
}

table.pyhltable {
    border-collapse: separate;
    border: 0;
    margin-bottom: 0;
    background: none;
}

table.pyhltable td {
    vertical-align: top;
    padding-top: 0;
    padding-bottom: 0;
}

table.pyhltable td.code {
    padding-left: .75em;
    padding-right: 0;
}

pre.pygments .lineno, table.pyhltable td:not(.code) {
    color: #999;
    padding-left: 0;
    padding-right: .5em;
    border-right: 1px solid #ddddd8;
}

pre.pygments .lineno {
    display: inline-block;
    margin-right: .25em;
}

table.pyhltable .linenodiv {
    background: none !important;
    padding-right: 0 !important;
}

.quoteblock {
    margin: 0 1em 1.25em 1.5em;
    display: table;
}

.quoteblock > .title {
    margin-left: -1.5em;
    margin-bottom: 0.75em;
}

.quoteblock blockquote, .quoteblock blockquote p {
    color: rgba(0, 0, 0, 0.85);
    font-size: 1.15rem;
    line-height: 1.75;
    word-spacing: 0.1em;
    letter-spacing: 0;
    font-style: italic;
    text-align: justify;
}

.quoteblock blockquote {
    margin: 0;
    padding: 0;
    border: 0;
}

.quoteblock blockquote:before {
    content: "\201c";
    float: left;
    font-size: 2.75em;
    font-weight: bold;
    line-height: 0.6em;
    margin-left: -0.6em;
    color: #7a2518;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

.quoteblock blockquote > .paragraph:last-child p {
    margin-bottom: 0;
}

.quoteblock .attribution {
    margin-top: 0.5em;
    margin-right: 0.5ex;
    text-align: right;
}

.quoteblock .quoteblock {
    margin-left: 0;
    margin-right: 0;
    padding: 0.5em 0;
    border-left: 3px solid rgba(0, 0, 0, 0.6);
}

.quoteblock .quoteblock blockquote {
    padding: 0 0 0 0.75em;
}

.quoteblock .quoteblock blockquote:before {
    display: none;
}

.verseblock {
    margin: 0 1em 1.25em 1em;
}

.verseblock pre {
    font-family: "Open Sans", "DejaVu Sans", sans;
    font-size: 1.15rem;
    color: rgba(0, 0, 0, 0.85);
    font-weight: 300;
    text-rendering: optimizeLegibility;
}

.verseblock pre strong {
    font-weight: 400;
}

.verseblock .attribution {
    margin-top: 1.25rem;
    margin-left: 0.5ex;
}

.quoteblock .attribution, .verseblock .attribution {
    font-size: 0.9375em;
    line-height: 1.45;
    font-style: italic;
}

.quoteblock .attribution br, .verseblock .attribution br {
    display: none;
}

.quoteblock .attribution cite, .verseblock .attribution cite {
    display: block;
    letter-spacing: -0.05em;
    color: rgba(0, 0, 0, 0.6);
}

.quoteblock.abstract {
    margin: 0 0 1.25em 0;
    display: block;
}

.quoteblock.abstract blockquote, .quoteblock.abstract blockquote p {
    text-align: left;
    word-spacing: 0;
}

.quoteblock.abstract blockquote:before, .quoteblock.abstract blockquote p:first-of-type:before {
    display: none;
}

table.tableblock {
    max-width: 100%;
    border-collapse: separate;
}

table.tableblock td > .paragraph:last-child p > p:last-child, table.tableblock th > p:last-child, table.tableblock td > p:last-child {
    margin-bottom: 0;
}

table.spread {
    width: 100%;
}

table.tableblock, th.tableblock, td.tableblock {
    border: 0 solid #dedede;
}

table.grid-all th.tableblock, table.grid-all td.tableblock {
    border-width: 0 1px 1px 0;
}

table.grid-all tfoot > tr > th.tableblock, table.grid-all tfoot > tr > td.tableblock {
    border-width: 1px 1px 0 0;
}

table.grid-cols th.tableblock, table.grid-cols td.tableblock {
    border-width: 0 1px 0 0;
}

table.grid-all * > tr > .tableblock:last-child, table.grid-cols * > tr > .tableblock:last-child {
    border-right-width: 0;
}

table.grid-rows th.tableblock, table.grid-rows td.tableblock {
    border-width: 0 0 1px 0;
}

table.grid-all tbody > tr:last-child > th.tableblock, table.grid-all tbody > tr:last-child > td.tableblock, table.grid-all thead:last-child > tr > th.tableblock, table.grid-rows tbody > tr:last-child > th.tableblock, table.grid-rows tbody > tr:last-child > td.tableblock, table.grid-rows thead:last-child > tr > th.tableblock {
    border-bottom-width: 0;
}

table.grid-rows tfoot > tr > th.tableblock, table.grid-rows tfoot > tr > td.tableblock {
    border-width: 1px 0 0 0;
}

table.frame-all {
    border-width: 1px;
}

table.frame-sides {
    border-width: 0 1px;
}

table.frame-topbot {
    border-width: 1px 0;
}

th.halign-left, td.halign-left {
    text-align: left;
}

th.halign-right, td.halign-right {
    text-align: right;
}

th.halign-center, td.halign-center {
    text-align: center;
}

th.valign-top, td.valign-top {
    vertical-align: top;
}

th.valign-bottom, td.valign-bottom {
    vertical-align: bottom;
}

th.valign-middle, td.valign-middle {
    vertical-align: middle;
}

table thead th, table tfoot th {
    font-weight: bold;
}

tbody tr th {
    display: table-cell;
    line-height: 1.6;
    background: #f7f8f7;
}

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p {
    color: rgba(0, 0, 0, 0.8);
    font-weight: bold;
}

p.tableblock > code:only-child {
    background: none;
    padding: 0;
}

p.tableblock {
    font-size: 1em;
}

td > div.verse {
    white-space: pre;
}

ol {
    margin-left: 1.75em;
}

ul li ol {
    margin-left: 1.5em;
}

dl dd {
    margin-left: 1.125em;
}

dl dd:last-child, dl dd:last-child > :last-child {
    margin-bottom: 0;
}

ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist {
    margin-bottom: 0.625em;
}

ul.unstyled, ol.unnumbered, ul.checklist, ul.none {
    list-style-type: none;
}

ul.unstyled, ol.unnumbered, ul.checklist {
    margin-left: 0.625em;
}

ul.checklist li > p:first-child > .fa-square-o:first-child, ul.checklist li > p:first-child > .fa-check-square-o:first-child {
    width: 1em;
    font-size: 0.85em;
}

ul.checklist li > p:first-child > input[type="checkbox"]:first-child {
    width: 1em;
    position: relative;
    top: 1px;
}

ul.inline {
    margin: 0 auto 0.625em auto;
    margin-left: -1.375em;
    margin-right: 0;
    padding: 0;
    list-style: none;
    overflow: hidden;
}

ul.inline > li {
    list-style: none;
    float: left;
    margin-left: 1.375em;
    display: block;
}

ul.inline > li > * {
    display: block;
}

.unstyled dl dt {
    font-weight: normal;
    font-style: normal;
}

ol.arabic {
    list-style-type: decimal;
}

ol.decimal {
    list-style-type: decimal-leading-zero;
}

ol.loweralpha {
    list-style-type: lower-alpha;
}

ol.upperalpha {
    list-style-type: upper-alpha;
}

ol.lowerroman {
    list-style-type: lower-roman;
}

ol.upperroman {
    list-style-type: upper-roman;
}

ol.lowergreek {
    list-style-type: lower-greek;
}

.hdlist > table, .colist > table {
    border: 0;
    background: none;
}

.hdlist > table > tbody > tr, .colist > table > tbody > tr {
    background: none;
}

td.hdlist1 {
    padding-right: .75em;
    font-weight: bold;
}

td.hdlist1, td.hdlist2 {
    vertical-align: top;
}

.literalblock + .colist, .listingblock + .colist {
    margin-top: -0.5em;
}

.colist > table tr > td:first-of-type {
    padding: 0 0.75em;
    line-height: 1;
}

.colist > table tr > td:last-of-type {
    padding: 0.25em 0;
}

.thumb, .th {
    line-height: 0;
    display: inline-block;
    border: solid 4px white;
    -webkit-box-shadow: 0 0 0 1px #dddddd;
    box-shadow: 0 0 0 1px #dddddd;
}

.imageblock.left, .imageblock[style*="float: left"] {
    margin: 0.25em 0.625em 1.25em 0;
}

.imageblock.right, .imageblock[style*="float: right"] {
    margin: 0.25em 0 1.25em 0.625em;
}

.imageblock > .title {
    margin-bottom: 0;
}

.imageblock.thumb, .imageblock.th {
    border-width: 6px;
}

.imageblock.thumb > .title, .imageblock.th > .title {
    padding: 0 0.125em;
}

.image.left, .image.right {
    margin-top: 0.25em;
    margin-bottom: 0.25em;
    display: inline-block;
    line-height: 0;
}

.image.left {
    margin-right: 0.625em;
}

.image.right {
    margin-left: 0.625em;
}

a.image {
    text-decoration: none;
}

span.footnote, span.footnoteref {
    vertical-align: super;
    font-size: 0.875em;
}

span.footnote a, span.footnoteref a {
    text-decoration: none;
}

span.footnote a:active, span.footnoteref a:active {
    text-decoration: underline;
}

#footnotes {
    padding-top: 0.75em;
    padding-bottom: 0.75em;
    margin-bottom: 0.625em;
}

#footnotes hr {
    width: 20%;
    min-width: 6.25em;
    margin: -.25em 0 .75em 0;
    border-width: 1px 0 0 0;
}

#footnotes .footnote {
    padding: 0 0.375em;
    line-height: 1.3;
    font-size: 0.875em;
    margin-left: 1.2em;
    text-indent: -1.2em;
    margin-bottom: .2em;
}

#footnotes .footnote a:first-of-type {
    font-weight: bold;
    text-decoration: none;
}

#footnotes .footnote:last-of-type {
    margin-bottom: 0;
}

#content #footnotes {
    margin-top: -0.625em;
    margin-bottom: 0;
    padding: 0.75em 0;
}

.gist .file-data > table {
    border: 0;
    background: #fff;
    width: 100%;
    margin-bottom: 0;
}

.gist .file-data > table td.line-data {
    width: 99%;
}

div.unbreakable {
    page-break-inside: avoid;
}

.big {
    font-size: larger;
}

.small {
    font-size: smaller;
}

.underline {
    text-decoration: underline;
}

.overline {
    text-decoration: overline;
}

.line-through {
    text-decoration: line-through;
}

.aqua {
    color: #00bfbf;
}

.aqua-background {
    background-color: #00fafa;
}

.black {
    color: black;
}

.black-background {
    background-color: black;
}

.blue {
    color: #0000bf;
}

.blue-background {
    background-color: #0000fa;
}

.fuchsia {
    color: #bf00bf;
}

.fuchsia-background {
    background-color: #fa00fa;
}

.gray {
    color: #606060;
}

.gray-background {
    background-color: #7d7d7d;
}

.green {
    color: #006000;
}

.green-background {
    background-color: #007d00;
}

.lime {
    color: #00bf00;
}

.lime-background {
    background-color: #00fa00;
}

.maroon {
    color: #600000;
}

.maroon-background {
    background-color: #7d0000;
}

.navy {
    color: #000060;
}

.navy-background {
    background-color: #00007d;
}

.olive {
    color: #606000;
}

.olive-background {
    background-color: #7d7d00;
}

.purple {
    color: #600060;
}

.purple-background {
    background-color: #7d007d;
}

.red {
    color: #bf0000;
}

.red-background {
    background-color: #fa0000;
}

.silver {
    color: #909090;
}

.silver-background {
    background-color: #bcbcbc;
}

.teal {
    color: #006060;
}

.teal-background {
    background-color: #007d7d;
}

.white {
    color: #bfbfbf;
}

.white-background {
    background-color: #fafafa;
}

.yellow {
    color: #bfbf00;
}

.yellow-background {
    background-color: #fafa00;
}

span.icon > .fa {
    cursor: default;
}

.admonitionblock td.icon [class^="fa icon-"] {
    font-size: 2.5em;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    cursor: default;
}

.admonitionblock td.icon .icon-note:before {
    content: "\f05a";
    color: #19407c;
}

.admonitionblock td.icon .icon-tip:before {
    content: "\f0eb";
    text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8);
    color: #111;
}

.admonitionblock td.icon .icon-warning:before {
    content: "\f071";
    color: #bf6900;
}

.admonitionblock td.icon .icon-caution:before {
    content: "\f06d";
    color: #bf3400;
}

.admonitionblock td.icon .icon-important:before {
    content: "\f06a";
    color: #bf0000;
}

.conum[data-value] {
    display: inline-block;
    color: #fff !important;
    background-color: rgba(0, 0, 0, 0.8);
    -webkit-border-radius: 100px;
    border-radius: 100px;
    text-align: center;
    font-size: 0.75em;
    width: 1.67em;
    height: 1.67em;
    line-height: 1.67em;
    font-family: "Open Sans", "DejaVu Sans", sans-serif;
    font-style: normal;
    font-weight: bold;
}

.conum[data-value] * {
    color: #fff !important;
}

.conum[data-value] + b {
    display: none;
}

.conum[data-value]:after {
    content: attr(data-value);
}

pre .conum[data-value] {
    position: relative;
    top: -0.125em;
}

b.conum * {
    color: inherit !important;
}

.conum:not([data-value]):empty {
    display: none;
}

h1, h2 {
    letter-spacing: -0.01em;
}

dt, th.tableblock, td.content {
    text-rendering: optimizeLegibility;
}

p, td.content {
    letter-spacing: -0.01em;
}

p strong, td.content strong {
    letter-spacing: -0.005em;
}

p, blockquote, dt, td.content {
    font-size: 1.0625rem;
}

p {
    margin-bottom: 1.25rem;
}

.sidebarblock p, .sidebarblock dt, .sidebarblock td.content, p.tableblock {
    font-size: 1em;
}

.exampleblock > .content {
    background-color: #fffef7;
    border-color: #e0e0dc;
    -webkit-box-shadow: 0 1px 4px #e0e0dc;
    box-shadow: 0 1px 4px #e0e0dc;
}

.print-only {
    display: none !important;
}

@media print {
    @page {
        margin: 1.25cm 0.75cm;
    }

    * {
        -webkit-box-shadow: none !important;
        box-shadow: none !important;
        text-shadow: none !important;
    }

    a {
        color: inherit !important;
        text-decoration: underline !important;
    }

    a.bare, a[href^="#"], a[href^="mailto:"] {
        text-decoration: none !important;
    }

    a[href^="http:"]:not(.bare):after, a[href^="https:"]:not(.bare):after {
        content: "(" attr(href) ")";
        display: inline-block;
        font-size: 0.875em;
        padding-left: 0.25em;
    }

    abbr[title]:after {
        content: " (" attr(title) ")";
    }

    pre, blockquote, tr, img {
        page-break-inside: avoid;
    }

    thead {
        display: table-header-group;
    }

    img {
        max-width: 100% !important;
    }

    p, blockquote, dt, td.content {
        font-size: 1em;
        orphans: 3;
        widows: 3;
    }

    h2, h3, #toctitle, .sidebarblock > .content > .title, #toctitle, .sidebarblock > .content > .title {
        page-break-after: avoid;
    }

    #toc, .sidebarblock, .exampleblock > .content {
        background: none !important;
    }

    #toc {
        border-bottom: 1px solid #ddddd8 !important;
        padding-bottom: 0 !important;
    }

    .sect1 {
        padding-bottom: 0 !important;
    }

    .sect1 + .sect1 {
        border: 0 !important;
    }

    #header > h1:first-child {
        margin-top: 1.25rem;
    }

    body.book #header {
        text-align: center;
    }

    body.book #header > h1:first-child {
        border: 0 !important;
        margin: 2.5em 0 1em 0;
    }

    body.book #header .details {
        border: 0 !important;
        display: block;
        padding: 0 !important;
    }

    body.book #header .details span:first-child {
        margin-left: 0 !important;
    }

    body.book #header .details br {
        display: block;
    }

    body.book #header .details br + span:before {
        content: none !important;
    }

    body.book #toc {
        border: 0 !important;
        text-align: left !important;
        padding: 0 !important;
        margin: 0 !important;
    }

    body.book #toc, body.book #preamble, body.book h1.sect0, body.book .sect1 > h2 {
        page-break-before: always;
    }

    .listingblock code[data-lang]:before {
        display: block;
    }

    #footer {
        background: none !important;
        padding: 0 0.9375em;
    }

    #footer-text {
        color: rgba(0, 0, 0, 0.6) !important;
        font-size: 0.9em;
    }

    .hide-on-print {
        display: none !important;
    }

    .print-only {
        display: block !important;
    }

    .hide-for-print {
        display: none !important;
    }

    .show-for-print {
        display: inherit !important;
    }
}

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.js"></script>
<script>document.addEventListener('DOMContentLoaded', prettyPrint)</script>
</head>
<body class="book">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="_postgresql_cluster">PostgreSQL Cluster</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We will setup two nodes as redundant <em>PostgreSQL DB</em> (a primary and a standby), and one machine which will do the pooling and distribution.
The pool is a single point of failure and ideally should also be redundant (which is why it is installed on the OpenNMS servers).
For our case, the most important is that all data stays available in case of a failure.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/pgpool-sql-queries.png" alt="pgpool sql queries">
</div>
</div>
<div class="paragraph">
<p>As you can see in the above scheme, <em>SQL</em> queries will be distributed to the primary and standby, based on the type of query.
Data written to the master/primary should get replicated to the standby.</p>
</div>
<div class="paragraph">
<p>In case of a failure of the primary, the standby should replace the primary and become read-write.
This will make sure that the database stays available for all applications.
In the meanwhile, you can investigate what happened to the old primary and, after a check up, start it as the new standby.</p>
</div>
<div class="paragraph">
<p>The <em>PostgreSQL</em> Servers are going to use <em>repmgr</em>, to reduce the complexity of promoting a standby server to be the new primary, and for recovering a failed primary to be a new standby.</p>
</div>
<div class="paragraph">
<p>Because only one <em>OpenNMS</em> server will be running at a time thanks to the <em>RedHat Clustering Services</em>, the active <em>OpenNMS</em> server will have the role of the <em>Pgpool-II</em> server; in other words:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>pgpool server == opennms server</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_setup_the_primary_postgresql_node">Setup the Primary PostgreSQL node</h3>
<div class="paragraph">
<p>The first step is to install the <em>PostgreSQL</em> database for the master and configure it correctly for replication.</p>
</div>
<div class="paragraph">
<p>Let’s start with initializing <em>PostgreSQL</em>:</p>
</div>
<div class="paragraph">
<p>On <em>RHEL/CentOS 6</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv01 ~]# service postgresql-9.4 initdb
Initializing database:                                     [  OK  ]</code></pre>
</div>
</div>
<div class="paragraph">
<p>On <em>RHEL/CentOS 7</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv01 ~]# /usr/pgsql-9.4/bin/postgresql94-setup initdb
Initializing database ... OK</code></pre>
</div>
</div>
<div class="paragraph">
<p>Configure database access by editing <code>/var/lib/pgsql/9.4/data/pg_hba.conf</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>Unresolved directive in postgresql-cluster.adoc - include::../files/postgresql-cluster/pg_hba.conf[]</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, md5 has been added to all combinations of user/database/server, to ensure that a password will be required to connect to any database.</p>
</div>
<div class="paragraph">
<p>Configure <em>PostgreSQL</em> itself and streaming replication by editing <code>/var/lib/pgsql/9.4/data/postgresql.conf</code>, and updating the following attributes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>Unresolved directive in postgresql-cluster.adoc - include::../files/postgresql-cluster/postgresql.conf[]</code></pre>
</div>
</div>
<div class="paragraph">
<p>It’s a good idea to merge the changed parameters with the existing, default, contents of <code>postgresql.conf</code> since it contains a lot of useful comments (annotated).
I’ve just posted the effective settings here to keep it clear.</p>
</div>
<div class="paragraph">
<p>To get good values for your buffers and memory reservations, you can use this as a source:</p>
</div>
<div class="paragraph">
<p><a href="http://pgtune.leopard.in.ua/" class="bare">http://pgtune.leopard.in.ua/</a></p>
</div>
<div class="paragraph">
<p>Here is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>max_connections = 200
shared_buffers = 512MB
effective_cache_size = 1536MB
work_mem = 2621kB
maintenance_work_mem = 128MB</code></pre>
</div>
</div>
<div class="paragraph">
<p>Warning: The above settings should not be used with the <em>Vagrant VMs</em>, as these VMs only have 1GB of <em>RAM</em>.
That was just an example for a physical server with enough <em>RAM</em>.
Leave the default settings for the <em>Vagrant VMs</em>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
For <em>PostgreSQL 9.0</em> to <em>9.3</em>, <code>max_replication_slots</code> cannot be used.
           In case it is required to use an older version, you should replace <code>max_replication_slots</code> with:<br>
           <code>wal_keep_segments = 5000</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The reason of using <em>9.4</em> with replication slots is precisely because the above setting must be big in 9.3 (or older) to avoid issues with replication, but that forces to have a huge filesystem for /var/lib/pgsql. Either way, with replication slots, a standby server must not be down for a long time, otherwise, this might eat all the disk space allocated for <code>/var/lib/psql</code>.</p>
</div>
<div class="paragraph">
<p>By default, the configuration directory for <em>repmgr</em> is located at <code>/etc/repmgr/9.4/</code>.
It is recommended to make a copy of <code>repmgr.conf</code> (for documentation purposes), and replace the content of it with the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>Unresolved directive in postgresql-cluster.adoc - include::../files/postgresql-cluster/repmgr.conf[]</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
For <em>PostgreSQL 9.0</em> to <em>9.3</em>, <code>use_replication_slots</code> must be <code>0</code> (i.e. not enabled).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Don’t forget to set the owner of the configuration file to <em>postgres</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv01 ~]$ chown postgres:postgres /etc/repmgr/9.4/repmgr.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>Enable and Start <em>PostgreSQL</em> on the master:</p>
</div>
<div class="paragraph">
<p>On <em>CentOS/RHEL 6</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv01 ~]# chkconfig postgresql-9.4 on
[root@pgdbsrv01 ~]# service postgresql-9.4 start
Starting postgresql-9.4 service:                           [  OK  ]</code></pre>
</div>
</div>
<div class="paragraph">
<p>On <em>CentOS/RHEL 7</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv01 ~]# systemctl enable postgresql-9.4
ln -s '/usr/lib/systemd/system/postgresql-9.4.service' '/etc/systemd/system/multi-user.target.wants/postgresql-9.4.service'
[root@pgdbsrv01 ~]# systemctl start postgresql-9.4</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create the required users for replication, <em>repmgr</em>, <em>pgpool-II</em>, <em>opennms</em>, and the <em>repmgr</em> database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv01 ~]$ sudo su - postgres
-bash-4.2$ psql
psql (9.4.4)
Type "help" for help.

postgres=# CREATE ROLE pgpool SUPERUSER CREATEDB CREATEROLE INHERIT REPLICATION LOGIN ENCRYPTED PASSWORD 'pgpool';
CREATE ROLE
postgres=# CREATE USER repmgr SUPERUSER REPLICATION LOGIN ENCRYPTED PASSWORD 'repmgr';
CREATE ROLE
postgres=# CREATE DATABASE repmgr OWNER repmgr;
CREATE DATABASE
postgres=# CREATE USER opennms SUPERUSER CREATEDB ENCRYPTED PASSWORD 'opennms';
CREATE ROLE
postgres=# ALTER USER postgres WITH ENCRYPTED PASSWORD 'postgres';
ALTER ROLE
postgres=# \q
-bash-4.1$ exit
logout</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember to set appropriate passwords (the word between single quotes after the keyword PASSWORD).
For testing purposes, I’ve used the name of the user for its password to simplify the explanation and configuration examples.</p>
</div>
<div class="paragraph">
<p>The user <em>postgres</em> will be used for replication (as shown in the <code>pg_hba.conf</code> file), and for creating the <em>OpenNMS</em> database, so it requires a password.</p>
</div>
<div class="paragraph">
<p>In case you want to have a different user for replication, besides creating the user on the database as shown before, the <code>pg_hba.conf</code> file must be properly updated, as well as the <code>.pgpass</code> (more on this below).</p>
</div>
<div class="paragraph">
<p>Because <em>md5</em> has been configured on <code>pg_hba.conf</code>, it is important to create a <code>.pgpass</code> for the <em>postgres</em> user, with the password for the <em>repmgr</em> user in the database for all databases, and the password for the user created for replication in the database (i.e. the <em>postgres</em> user for this particular deployment):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv01 ~]$ su - postgres
-bash-4.2$ echo "*:*:*:repmgr:repmgr" &gt; ~/.pgpass
-bash-4.2$ echo "*:*:replication:postgres:postgres" &gt;&gt; ~/.pgpass
-bash-4.2$ chmod 600 ~/.pgpass
-bash-4.2$ cat ~/.pgpass
*:*:repmgr:repmgr:repmgr
-bash-4.1$ exit
logout
[root@pgdbsrv01 ~]$ restorecon -R /var/lib/pgsql/</code></pre>
</div>
</div>
<div class="paragraph">
<p>The last 3 keys of each <code>.pgpass</code> entry are respectively: the database name, the user and the password, so remember to use the appropriate users and passwords.
The permissions on this file must be <code>0600</code> and it is important to update the <em>SELinux</em> attributes.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
If you forgot to execute the <code>restorecon</code> command and <em>SELinux</em> is enforcing, the <code>.pgpass</code> file wont work in some cases.
           Of course, this is not the case if <em>SELinux</em> is permissive or disabled.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Refer to the following link for more details about <code>.pgpass</code> files:</p>
</div>
<div class="paragraph">
<p><a href="http://www.postgresql.org/docs/9.4/static/libpq-pgpass.html" class="bare">http://www.postgresql.org/docs/9.4/static/libpq-pgpass.html</a></p>
</div>
<div class="paragraph">
<p>The last step is to register <em>pgdbsrv01</em> as master node for <em>repmgr</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv01 ~]$ sudo su - postgres
-bash-4.1$ /usr/pgsql-9.4/bin/repmgr -f /etc/repmgr/9.4/repmgr.conf --verbose master register
[2015-07-13 10:13:09] [NOTICE] opening configuration file: /etc/repmgr/9.4/repmgr.conf
[2015-07-13 10:13:09] [INFO] connecting to master database
[2015-07-13 10:13:09] [INFO] connected to master, checking its state
[2015-07-13 10:13:09] [INFO] master register: creating database objects inside the repmgr_opennms_cluster schema
[2015-07-13 10:13:09] [NOTICE] master node correctly registered for cluster opennms_cluster with id 1 (conninfo: host=pgdbsrv01 user=repmgr dbname=repmgr)</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the <code>.pgpass</code> or the <em>DNS</em> is not well configured, the above command could fail or request a password for the <em>repmgr</em> user.</p>
</div>
</div>
<div class="sect2">
<h3 id="_setup_the_standby_postgresql_node">Setup the Standby PostgreSQL node</h3>
<div class="paragraph">
<p>Setting up the standby node doesn’t require a lot of configuration.
On the first sync with the primary, most of the configuration is taken from here.</p>
</div>
<div class="paragraph">
<p>It is important to copy the <code>.pgpass</code> file from the primary server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv02 ~]# su - postgres
-bash-4.1$ scp pgdbsrv01:~/.pgpass ~/.pgpass
.pgpass        100%   54     0.1KB/s   00:00
-bash-4.1$ exit
logout
[root@pgdbsrv02 ~]$ restorecon -R /var/lib/pgsql/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Configure <em>repmgr</em> similar to the primary by creating <code>/etc/repmgr/9.4/repmgr.conf</code> with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>cluster=opennms_cluster
node=2
node_name=pgdbsrv02
conninfo='host=pgdbsrv02 user=repmgr dbname=repmgr'
use_replication_slots=1
loglevel=INFO
pg_bindir=/usr/pgsql-9.4/bin/
pg_basebackup_options='--xlog-method=stream'
master_response_timeout=30
reconnect_attempts=3
reconnect_interval=10
failover=manual
promote_command='/usr/pgsql-9.4/bin/repmgr standby promote -f /etc/repmgr/9.4/repmgr.conf'
follow_command='/usr/pgsql-9.4/bin/repmgr standby follow -f /etc/repmgr/9.4/repmgr.conf'</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
For <em>PostgreSQL 9.0</em> to <em>9.3</em>, <code>use_replication_slots</code> must be <code>0</code> (i.e. not enabled).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Also notice that the first name (the <em>cluster ID</em>) must be the same on all members of the cluster.
Only the lines 2 to 4 are going to be different on each cluster node.</p>
</div>
<div class="paragraph">
<p>Don’t forget to set the owner of the configuration file to <em>postgres</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv02 ~]$ chown postgres:postgres /etc/repmgr/9.4/repmgr.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>Sync the configuration and contents of the primary with the standby:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv02 ~]$ sudo su - postgres
-bash-4.1$ /usr/pgsql-9.4/bin/repmgr -f /etc/repmgr/9.4/repmgr.conf --verbose -D /var/lib/pgsql/9.4/data -d repmgr -p 5432 -U repmgr -R postgres standby clone pgdbsrv01
[2015-07-13 10:46:54] [NOTICE] opening configuration file: /etc/repmgr/9.4/repmgr.conf
[2015-07-13 10:46:54] [NOTICE] destination directory '/var/lib/pgsql/9.4/data' provided
[2015-07-13 10:46:54] [INFO] connecting to upstream node
[2015-07-13 10:46:54] [INFO] connected to upstream node, checking its state
[2015-07-13 10:46:54] [INFO] Successfully connected to upstream node. Current installation size is 26 MB
[2015-07-13 10:46:54] [NOTICE] starting backup...
[2015-07-13 10:46:54] [INFO] checking and correcting permissions on existing directory /var/lib/pgsql/9.4/data ...
[2015-07-13 10:46:54] [INFO] executing: '/usr/pgsql-9.4/bin/pg_basebackup -l "repmgr base backup"  -h pgdbsrv01 -p 5432 -U repmgr -D /var/lib/pgsql/9.4/data --xlog-method=stream'
[2015-07-13 10:46:59] [NOTICE] standby clone (using pg_basebackup) complete
[2015-07-13 10:46:59] [NOTICE] HINT: you can now start your PostgreSQL server
[2015-07-13 10:46:59] [NOTICE] for example : pg_ctl -D /var/lib/pgsql/9.4/data start
-bash-4.1$ exit
logout</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
If the command execution ask for the password configured for the <em>repmgr</em> user, you might forgot to execute the <code>restorecon</code> command, to avoid <em>SELinux</em> issues when it is enforcing.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In case you experience problems with the synchronization and you need to repeat this step, first delete the contents of the <em>PostgreSQL</em> datadir (<code>rm -rf /var/lib/pgsql/9.4/data/*</code>) and try again.</p>
</div>
<div class="paragraph">
<p>On <em>RHEL/CentOS 6</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv02 ~]# chkconfig postgresql-9.4 on
[root@pgdbsrv02 ~]# service postgresql-9.4 start
Starting postgresql-9.4 service:                           [  OK  ]</code></pre>
</div>
</div>
<div class="paragraph">
<p>On <em>RHEL/CentOS 7</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv02 ~]# systemctl enable postgresql-9.4
ln -s '/usr/lib/systemd/system/postgresql-9.4.service' '/etc/systemd/system/multi-user.target.wants/postgresql-9.4.service'
[root@pgdbsrv02 ~]# systemctl start postgresql-9.4</code></pre>
</div>
</div>
<div class="paragraph">
<p>As the last step in the standby node setup, register the standby in <em>repmgr</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv02 ~]$ su - postgres
-bash-4.1$ /usr/pgsql-9.4/bin/repmgr -f /etc/repmgr/9.4/repmgr.conf --verbose standby register
[2015-07-13 10:49:24] [NOTICE] opening configuration file: /etc/repmgr/9.4/repmgr.conf
[2015-07-13 10:49:24] [INFO] connecting to standby database
[2015-07-13 10:49:24] [INFO] connecting to master database
[2015-07-13 10:49:24] [INFO] finding node list for cluster 'opennms_cluster'
[2015-07-13 10:49:24] [INFO] checking role of cluster node '1'
[2015-07-13 10:49:24] [INFO] registering the standby
[2015-07-13 10:49:24] [INFO] standby registration complete
[2015-07-13 10:49:24] [NOTICE] standby node correctly registered for cluster opennms_cluster with id 2 (conninfo: host=pgdbsrv02 user=repmgr dbname=repmgr)
-bash-4.1$ exit
logout</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_test_replication">Test Replication</h3>
<div class="paragraph">
<p>First, let’s check that all the servers are running the proper role.
The primary/master server should not have a <code>recovery.con</code> file, but that should exist on each standby server.
This file is automatically generated by <em>repmgr</em> as part of the execution of the <code>standby clone</code> command.</p>
</div>
<div class="paragraph">
<p>Another way to verify which server is the master, execute the following <em>SQL</em> query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-sql" data-lang="sql">SELECT pg_is_in_recovery();</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the value is true, you&#8217;re on a slave (or standby server); if false, you’re on the master/primary server:</p>
</div>
<div class="paragraph">
<p>On <em>pgdbsrv01</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv01 ~]# su - postgres
-bash-4.1$ psql
psql (9.4.4)
Type "help" for help.

postgres=# SELECT pg_is_in_recovery();
 pg_is_in_recovery
-------------------
 f
(1 row)

postgres=# \q</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv01 ~]# su - postgres -c 'psql -c "SELECT pg_is_in_recovery();"'
 pg_is_in_recovery
-------------------
 f
(1 row)</code></pre>
</div>
</div>
<div class="paragraph">
<p>On <em>pgdbsrv02</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv02 ~]# su - postgres
-bash-4.1$ psql
psql (9.4.4)
Type "help" for help.

postgres=# SELECT pg_is_in_recovery();
 pg_is_in_recovery
-------------------
 t
(1 row)

postgres=# \q</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also check the <em>repmgr</em> tables to verify if the nodes have been successfully registered:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>|---
[root@pgdbsrv01 ~]# su - postgres
-bash-4.1$ psql -x -U repmgr -h pgdbsrv01 -d repmgr -c "SELECT * FROM repmgr_opennms_cluster.repl_nodes;"
-[ RECORD 1 ]----+-----------------------------------------
id               | 1
type             | master
upstream_node_id |
cluster          | opennms_cluster
name             | pgdbsrv01
conninfo         | host=pgdbsrv01 user=repmgr dbname=repmgr
slot_name        | repmgr_slot_1
priority         | 100
active           | t
-[ RECORD 2 ]----+-----------------------------------------
id               | 2
type             | standby
upstream_node_id | 1
cluster          | opennms_cluster
name             | pgdbsrv02
conninfo         | host=pgdbsrv02 user=repmgr dbname=repmgr
slot_name        | repmgr_slot_2
priority         | 100
active           | t
|---</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
that the query has been executed against the primary server.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is important to have in mind that the name of the view starts with the word "repmgr", then the underscore character ("_"), and then the name of the cluster (in this case, <code>opennms_cluster</code>, as it was defined on <code>repmgr.conf</code>); in other words: <code>repmgr_opennms_cluster</code>.
This is the main reason why you should never use special characters when choosing the name of the cluster.</p>
</div>
<div class="paragraph">
<p>Another way to have a quick status of the cluster is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv01 ~]# su - postgres -c "/usr/pgsql-9.4/bin/repmgr -f /etc/repmgr/9.4/repmgr.conf cluster show"
[2015-07-13 10:56:35] [INFO] connecting to database
Role      | Connection String
* master  | host=pgdbsrv01 user=repmgr dbname=repmgr
  standby | host=pgdbsrv02 user=repmgr dbname=repmgr</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above command can be executed on any <em>PostgreSQL</em> server.</p>
</div>
<div class="paragraph">
<p>Finally, you can use the following command on the primary server to see the statistics from the replication.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">|---
[root@pgdbsrv01 ~]# su - postgres -c "psql -x -c 'select * from pg_stat_replication;'"
-[ RECORD 1 ]----+------------------------------
pid              | 3391
usesysid         | 16385
usename          | repmgr
application_name | pgdbsrv02
client_addr      | 192.168.205.154
client_hostname  | pgdbsrv02.local
client_port      | 49663
backend_start    | 2015-07-13 11:34:19.452167-04
backend_xmin     |
state            | streaming
sent_location    | 0/C001B78
write_location   | 0/C001B78
flush_location   | 0/C001B78
replay_location  | 0/C001B78
sync_priority    | 0
sync_state       | async
|---</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also you should see that the replication processes are running on the standby server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv02 ~]# ps aux | egrep 'wal\sreceiver'
postgres   3377  0.0  0.3 345876  3176 ?        Ss   11:34   0:01 postgres: wal receiver process   streaming 0/C001B78</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the output of the above commands is empty, check the credentials on the <code>.pgpass</code> file, the <em>DNS</em>, the connection between the database servers, the internal firewall, and <code>pg_hba.conf</code>.</p>
</div>
<div class="paragraph">
<p>At this point, updates on the master should be replicated to the slave so it’s a good time to see if that really works as we would expect by creating a new database on the primary node.</p>
</div>
<div class="paragraph">
<p>Before we create a sample database on the primary, let’s list the databases from the standby-node:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">|---
[root@pgdbsrv01 ~]# su - postgres -c "psql -c '\list'"
                                  List of databases
   Name    |  Owner   | Encoding |   Collate   |    Ctype    |   Access privileges
-----------+----------+----------+-------------+-------------+-----------------------
 postgres  | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |
 repmgr    | repmgr   | UTF8     | en_US.UTF-8 | en_US.UTF-8 |
 template0 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +
           |          |          |             |             | postgres=CTc/postgres
 template1 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +
           |          |          |             |             | postgres=CTc/postgres
(4 rows)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create the database on the primary:</p>
</div>
<div class="paragraph">
<p>[root@pgdbsrv01 ~]# su - postgres -c "psql -c 'CREATE DATABASE test'"
CREATE DATABASE
|---</p>
</div>
<div class="paragraph">
<p>Same command as we did before the <em>DB-create</em>: list the current databases on the standby:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">|---
[root@pgdbsrv02 ~]# su - postgres -c "psql -c '\list'"
                                  List of databases
   Name    |  Owner   | Encoding |   Collate   |    Ctype    |   Access privileges
-----------+----------+----------+-------------+-------------+-----------------------
 postgres  | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |
 repmgr    | repmgr   | UTF8     | en_US.UTF-8 | en_US.UTF-8 |
 template0 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +
           |          |          |             |             | postgres=CTc/postgres
 template1 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +
           |          |          |             |             | postgres=CTc/postgres
 test      | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |
(5 rows)
|---</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, the new database, test, got replicated to the standby.</p>
</div>
<div class="paragraph">
<p>Another test which you could do, is to check if the standby is read-only:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv02 ~]# su - postgres -c "psql -c 'CREATE DATABASE test2'"
ERROR:  cannot execute CREATE DATABASE in a read-only transaction</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above result is good, since we don’t want somebody to update our standby, everything should pass via the primary and get replicated to the standby.</p>
</div>
<div class="paragraph">
<p>Finally, remove the test database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv01 ~]# su - postgres -c "psql -c 'DROP DATABASE test'"
DROP DATABASE</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you check the standby server again, you should see that the test <em>DB</em>: is not there, as expected.</p>
</div>
</div>
<div class="sect2">
<h3 id="_setup_pgpool_ii">Setup Pgpool-II</h3>
<div class="paragraph">
<p>The next chapter is to setup <em>pgpool-II</em> in order to distribute queries to the primary and standby, and to make sure that we failover to the standby in case the primary isn’t available anymore.</p>
</div>
<div class="paragraph">
<p>Configure <em>pgpool-II</em> by copying the sample configuration file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@onmssrv01 ~]$ cd /etc/pgpool-II/
[root@onmssrv01 pgpool-II]$ cp pgpool.conf.sample-stream pgpool.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>Edit the following settings in the copied sample file <code>/etc/pgpool-II/pgpool.conf</code>, do not replace the contents of the file but edit everything listed under here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">listen_addresses = '*'
port = 9999
backend_hostname0 = 'pgdbsrv01'
backend_port0 = 5432
backend_weight0 = 1
backend_data_directory0 = '/var/lib/pgsql/9.4/data'
backend_flag0 = 'ALLOW_TO_FAILOVER'
backend_hostname1 = 'pgdbsrv02'
backend_port1 = 5432
backend_weight1 = 1
backend_data_directory1 = '/var/lib/pgsql/9.4/data'
backend_flag1 = 'ALLOW_TO_FAILOVER'
enable_pool_hba = on
pool_passwd = 'pool_passwd'
authentication_timeout = 60
num_init_children = 60
max_pool = 1
child_max_connections = 0
pid_file_name = '/var/run/pgpool/pgpool.pid'
logdir = '/var/log/pgpool'
connection_cache = on
replication_mode = off
load_balance_mode = on
master_slave_mode = on
master_slave_sub_mode = 'stream'
sr_check_user = 'pgpool'
sr_check_password = 'pgpool'
health_check_period = 10
health_check_user = 'pgpool'
health_check_password = 'pgpool'
failover_command = '/etc/pgpool-II/failover.sh %h %H'
recovery_user = 'pgpool'
recovery_password = 'pgpool'</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Replace the sample password of the <em>pgpool</em> user accordingly (not required for the <em>Vagrant lab</em>).
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
For <em>RHEL/CentOS 6</em>, the <code>pid_file_name</code> must be <code>/var/run/pgpool/pgpool.pid</code>.
           For <em>RHEL/CentOS 7</em> this is enforced through <code>pgpool.service</code> (the <em>systemd</em> initialization script).
           That way, the content of <code>pgpool.conf</code> is the same for both operating systems.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Having the password on a configuration file is not optimal, but unfortunately, this is something that is still required for the <em>pgpool-II</em> version installed on the systems (which is the latest one by the time this document was written).</p>
</div>
<div class="paragraph">
<p>Also, be sure that <code>num_init_children</code> is consistent with the required number of connections in <em>OpenNMS</em>, and the configured <code>max_connections</code> in <code>postgresql.conf</code>.</p>
</div>
<div class="paragraph">
<p>To reduce possible security holes, change the permissions of the file to be <code>0600</code>, and make the user <em>postgres</em> to own the file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@onmssrv01 ~]$ chmod 0600 /etc/pgpool-II/pgpool.conf
[root@onmssrv01 ~]$ chown postgres:postgres /etc/pgpool-II/pgpool.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>The selected port is the default (i.e. 9999).
It is possible to change it to <em>PostgreSQL’s</em> default (i.e. 5432), but I’ve chosen 9999 to remember that we’re connecting to <em>pgpool-II</em> and not directly to the <em>PostgreSQL</em> servers.</p>
</div>
<div class="paragraph">
<p>The online recovery feature won’t be used.
It is recommended that the server administrator manually execute the recovery procedure on the broken <em>DB</em> server, to convert it into a new slave server.</p>
</div>
<div class="paragraph">
<p>On the above settings, we specified that on failover, the script <code>failover.sh</code> should be executed, so we’ll need to create this file in <code>/etc/pgpool-II/failover.sh</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">Unresolved directive in postgresql-cluster.adoc - include::../files/postgresql-cluster/failover.sh[]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember to fix the permissions on the failover script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@onmssrv01 ~]$ chmod 0700 /etc/pgpool-II/failover.sh
[root@onmssrv01 ~]$ chown postgres:postgres /etc/pgpool-II/failover.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>We also specified in the configuration that we want to use <code>pool_hba.conf</code>, so we need to add the credentials to the <code>/etc/pgpool-II/pool_hba.conf</code> file.</p>
</div>
<div class="paragraph">
<p>Due to a known problem in <em>pgpool-II</em>, it is not possible to mix authentication methods on <code>pool_hba.conf</code>.
For this reason, and because <em>md5</em> has been configured on all the <em>PostgreSQL</em> servers, the content of the <code>pool_hba.conf</code> file must be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash"># "local" is for Unix domain socket connections only
local   all         all                               md5
# IPv4 local connections:
host    all         all         127.0.0.1/32          md5
host    all         all         ::1/128               md5
host    all         all         0.0.0.0/0             md5</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember to fix the permissions on the failover script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@onmssrv01 ~]$ chmod 0600 /etc/pgpool-II/pool_hba.conf
[root@onmssrv01 ~]$ chown postgres:postgres /etc/pgpool-II/pool_hba.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>Every user that needs to connect via <em>pgpool-II</em> needs to be added in <code>pool_passwd</code>.
First we need to create this file and let it be owned by <em>postgres</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@onmssrv01 ~]# touch /etc/pgpool-II/pool_passwd
[root@onmssrv01 ~]# chmod 600 /etc/pgpool-II/pool_passwd
[root@onmssrv01 ~]# chown postgres:postgres /etc/pgpool-II/pool_passwd</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, we can add users to the file.
Let’s do that for the <em>pgpool</em> user which we created earlier:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@onmssrv01 ~]# su - postgres -c "pg_md5 -m -u pgpool pgpool"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You’ll have to repeat this step for every user that needs access to the <em>DB</em> (including the replication user if you have one), in other words:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@onmssrv01 ~]# su - postgres -c "pg_md5 -m -u repmgr repmgr"
[root@onmssrv01 ~]# su - postgres -c "pg_md5 -m -u opennms opennms"
[root@onmssrv01 ~]# su - postgres -c "pg_md5 -m -u postgres postgres"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The passwords will be stored as <em>MD5</em> strings, and must be the same passwords configured on the databases.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
I’ve used the sample passwords for the <em>Vagrant lab</em>, so remember to use the appropriate passwords.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Last step is to allow connection via <em>PCP</em> to <code>manage postgres</code>.
This requires a similar approach as with <code>pool_passwd</code>.
For simplicity, I’ve chosen the <em>postgres</em> user (with the same password).
It can be a brand new user if required.
This will be the user required to execute <em>PCP</em> commands.</p>
</div>
<div class="paragraph">
<p>Generate the <em>MD5</em> form for the chosen password (i.e. the word <code>postgres</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@onmssrv01 ~]# pg_md5 postgres
e8a48653851e28c69d0506508fb27fc5</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, add the user with the above password to <code>pcp.conf</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@onmssrv01 ~]# echo "postgres:e8a48653851e28c69d0506508fb27fc5" &gt;&gt; /etc/pgpool-II/pcp.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember to fix the permissions on the failover script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@onmssrv01 ~]$ chmod 0600 /etc/pgpool-II/pcp.conf
[root@onmssrv01 ~]$ chown postgres:postgres /etc/pgpool-II/pcp.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>At the end, you should have something like the following at <code>/etc/pgpool-II/</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre> -rwx------. 1 postgres postgres   278 Jul 13 12:11 failover.sh
 -rw-------. 1 postgres postgres   901 Jul 13 12:20 pcp.conf
 -rw-------. 1 postgres postgres 32939 Jul 13 12:08 pgpool.conf
 -rw-------. 1 postgres postgres  3312 Jul 13 12:15 pool_hba.conf
 -rw-------. 1 postgres postgres   175 Jul 13 12:16 pool_passwd</pre>
</div>
</div>
<div class="paragraph">
<p>You can either backup, move, delete or leave untouched the sample files.</p>
</div>
<div class="paragraph">
<p>Make sure the log directories for <em>pgpool-II</em> exist and have proper permissions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@onmssrv01 ~]$ mkdir /var/log/pgpool
[root@onmssrv01 ~]$ chown postgres:postgres /var/log/pgpool
[root@onmssrv02 ~]$ mkdir /var/log/pgpool
[root@onmssrv02 ~]$ chown postgres:postgres /var/log/pgpool</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you have all the files properly configured, use <em>rsync</em> to copy over all the files to the other <em>Pgpool-II</em> server (i.e. <em>onmssrv02</em>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@onmssrv01 ~]# rsync -avr --delete /etc/pgpool-II/ onmssrv02:/etc/pgpool-II/</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>pgpool-II</em> service is ready to be started.</p>
</div>
</div>
<div class="sect2">
<h3 id="_recommendation">Recommendation</h3>
<div class="paragraph">
<p>The <em>pgpool-II</em> configuration files are common to both <em>OpenNMS</em> servers.
For this reason, they must be stored on a shared server and expose them through <em>NFS</em> (or a similar technology, as mentioned before).
It is important to know that there are some configuration changes on the <em>NFS</em> server that are strictly required in order to respect the ownership of the files when it is not root.</p>
</div>
<div class="paragraph">
<p>As described on an earlier section, on our current testing deployment, the domain of all the servers is <code>local</code>.
For this reason, the <code>/etc/idmapd.conf</code> file on all the machines (including the <em>NFS</em> server) must be updated accordingly.
In this case:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[General]
#Verbosity = 0
# The following should be set to the local NFSv4 domain name
# The default is the host's DNS domain name.
Domain = local
[source, bash]</code></pre>
</div>
</div>
<div class="paragraph">
<p>It might be possible that other changes are required in order to make it work on certain environments.
Also the <em>postgres</em> user must be created on the <em>NFS</em> server (more on this later).</p>
</div>
<div class="paragraph">
<p>If this is not configured properly, the <em>pgpool-II</em> files will appear owned by the nobody user which is not correct, and will prevent the proper work of pgpool-II. When this happens, you should see an error similar to the following on the logs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">Jul  7 22:26:39 onmssrv01 nfsidmap[102421]: nss_getpwnam: name 'nobody' does not map into domain 'local'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The current workaround is to make the changes on one server and then <em>rsync</em> the directory to the other server, as explained before.</p>
</div>
<div class="sect3">
<h4 id="_test_pgpool_ii">Test Pgpool-II</h4>
<div class="paragraph">
<p>If all went well, at this point, you should have a working installation of <em>pgpool-II</em> that will execute queries on the replicated <em>PostgreSQL</em> nodes.</p>
</div>
<div class="paragraph">
<p>First, verify with the <code>psql</code> command that you can reach the databases using the <em>pgpool-II</em> user:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@onmssrv01 ~]# psql -U pgpool -h pgdbsrv01 -d postgres
Password for user pgpool:
psql (9.4.4)
Type "help" for help.

postgres=# \q
[root@onmssrv01 ~]# psql -U pgpool -h pgdbsrv02 -d postgres
Password for user pgpool:
psql (9.4.4)
Type "help" for help.

postgres=# \q</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you can’t connect to the databases, check <em>iptables</em>, the user credentials and <code>pg_hba.conf</code> on the database servers and the <em>pgpool-II</em> configuration files.</p>
</div>
<div class="paragraph">
<p>Remember to test the connection from the other <em>OpenNMS</em> server (i.e. <em>onmssrv02</em>).</p>
</div>
<div class="paragraph">
<p>In order to test <em>pgpool-II</em>, we need to start the service.
Execute the following commands from one <em>OpenNMS</em> server only, as the <em>pgpool-II</em> should run on one machine.</p>
</div>
<div class="paragraph">
<p>On <em>RHEL/CentOS 6</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@onmssrv01 ~]# service pgpool start</code></pre>
</div>
</div>
<div class="paragraph">
<p>On <em>RHEL/CentOS 7</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@onmssrv01 ~]# systemctl start pgpool</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check the logs to verify <em>pgpool-II</em> was started correctly:</p>
</div>
<div class="paragraph">
<p>On <em>RHEL/CentOS 6</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@onmssrv01 ~]# cat /var/log/pgpool.log
2015-07-13 12:33:05: pid 2145: LOG:  Backend status file /var/log/pgpool_status does not exist
2015-07-13 12:33:05: pid 2145: LOG:  Setting up socket for 0.0.0.0:9999
2015-07-13 12:33:05: pid 2145: LOG:  Setting up socket for :::9999
2015-07-13 12:33:05: pid 2145: LOG:  pgpool-II successfully started. version 3.4.2 (tataraboshi)
2015-07-13 12:33:05: pid 2145: LOG:  find_primary_node: checking backend no 0
2015-07-13 12:33:05: pid 2145: LOG:  find_primary_node: primary node id is 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>On <em>RHEL/CentOS 7</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@onmssrv01 ~]# systemctl status pgpool
pgpool.service - pgpool-II
   Loaded: loaded (/usr/lib/systemd/system/pgpool.service; disabled)
   Active: active (running) since Wed 2015-07-29 18:38:18 UTC; 2min 41s ago
 Main PID: 18369 (pgpool)
   CGroup: /system.slice/pgpool.service
           ├─18369 /usr/bin/pgpool -f /etc/pgpool-II/pgpool.conf -n
           ├─18437 pgpool: wait for connection request
           ├─18438 pgpool: wait for connection request
…
           ├─18722 pgpool: PCP: wait for connection request
           └─18723 pgpool: worker process

Jul 29 18:55:02 onmssrv01.local systemd[1]: Starting pgpool-II...
Jul 29 18:55:02 onmssrv01.local systemd[1]: Started pgpool-II.
Jul 29 18:55:02 onmssrv01.local pgpool[18661]: 2015-07-29 18:55:02: pid 18661: LOG:  reading status file: 1 th backend is set to down status
Jul 29 18:55:02 onmssrv01.local pgpool[18661]: 2015-07-29 18:55:02: pid 18661: LOG:  Setting up socket for 0.0.0.0:9999
Jul 29 18:55:02 onmssrv01.local pgpool[18661]: 2015-07-29 18:55:02: pid 18661: LOG:  Setting up socket for :::9999
Jul 29 18:55:02 onmssrv01.local pgpool[18661]: 2015-07-29 18:55:02: pid 18661: LOG:  pgpool-II successfully started. version 3.4.3 (tataraboshi)
Jul 29 18:55:02 onmssrv01.local pgpool[18661]: 2015-07-29 18:55:02: pid 18661: LOG:  find_primary_node: checking backend no 0
Jul 29 18:55:02 onmssrv01.local pgpool[18661]: 2015-07-29 18:55:02: pid 18661: LOG:  find_primary_node: primary node id is 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@onmssrv01 ~]# journalctl | grep pgpool | tail
Jul 29 18:58:41 onmssrv01.local systemd[1]: Stopped pgpool-II.
Jul 29 18:58:46 onmssrv01.local systemd[1]: Starting pgpool-II...
Jul 29 18:58:46 onmssrv01.local systemd[1]: Started pgpool-II.
Jul 29 18:58:46 onmssrv01.local pgpool[18740]: 2015-07-29 18:58:46: pid 18740: LOG:  Setting up socket for 0.0.0.0:9999
Jul 29 18:58:46 onmssrv01.local pgpool[18740]: 2015-07-29 18:58:46: pid 18740: LOG:  Setting up socket for :::9999
Jul 29 18:58:46 onmssrv01.local pgpool[18740]: 2015-07-29 18:58:46: pid 18740: LOG:  pgpool-II successfully started. version 3.4.3 (tataraboshi)
Jul 29 18:58:46 onmssrv01.local pgpool[18740]: 2015-07-29 18:58:46: pid 18740: LOG:  find_primary_node: checking backend no 0
Jul 29 18:58:46 onmssrv01.local pgpool[18740]: 2015-07-29 18:58:46: pid 18740: LOG:  find_primary_node: primary node id is 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s test if everything is working by executing a query on the databases via <em>pgpool-II</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">|---
[root@onmssrv01 ~]# psql -U pgpool -h onmssrv01 -p 9999 -d postgres -c "\l"
Password for user pgpool:
                                  List of databases
   Name    |  Owner   | Encoding |   Collate   |    Ctype    |   Access privileges
-----------+----------+----------+-------------+-------------+-----------------------
 postgres  | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |
 repmgr    | repmgr   | UTF8     | en_US.UTF-8 | en_US.UTF-8 |
 template0 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +
           |          |          |             |             | postgres=CTc/postgres
 template1 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +
           |          |          |             |             | postgres=CTc/postgres
(4 rows)
|---</code></pre>
</div>
</div>
<div class="paragraph">
<p>This should also work from another host that has network access to the <em>pgpool-II</em> machine.</p>
</div>
<div class="paragraph">
<p><em>Pgpool-II</em> has a range of <code>show</code>-commands available that allow you to get the status of <em>pgpool-II</em> itself.
They’re executed as normal <em>SQL</em> but will be intercepted by <em>pgpool-II</em>.</p>
</div>
<div class="paragraph">
<p>To get the status of the nodes connected to <em>pgpool-II</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">|---
[root@onmssrv01 ~]# psql -U pgpool -h onmssrv01 -p 9999 -d postgres -c "show pool_nodes"
Password for user pgpool:
 node_id | hostname  | port | status | lb_weight |  role
---------+-----------+------+--------+-----------+---------
 0       | pgdbsrv01 | 5432 | 2      | 0.500000  | primary
 1       | pgdbsrv02 | 5432 | 2      | 0.500000  | standby
(2 rows)
|---</code></pre>
</div>
</div>
<div class="paragraph">
<p>If for some reason, the status is not 2 or you see problems on the logs, double check the configuration of pgpool in pgpool.conf (specially the section related with the <em>PostgreSQL</em> servers).
It might be possible that you must re-attach the failed server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@onmssrv01 ~]# pcp_attach_node 0 localhost 9898 postgres postgres X</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace X with the <code>node_id</code> from the <code>show pool_nodes</code> command.</p>
</div>
<div class="paragraph">
<p>Finally, stop the <em>pgpool-II</em> service and repeat the connection test from <em>onmssrv02</em>.</p>
</div>
<div class="paragraph">
<p>On <em>RHEL/CentOS 6</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@onmssrv01 ~]# service pgpool stop</code></pre>
</div>
</div>
<div class="paragraph">
<p>On <em>RHEL/CentOS 7</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@onmssrv01 ~]# systemctl stop pgpool</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_test_failover">Test Failover</h3>
<div class="paragraph">
<p>In order to test the failover with <em>pgpool-II</em>, the application must be running on one of the <em>OpenNMS</em> servers; so make sure it is running before continue.</p>
</div>
<div class="paragraph">
<p>We can easily test the failover scenario by bringing down the primary database node and see what happens:</p>
</div>
<div class="paragraph">
<p>On <em>RHEL/CentOS 6</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv01 ~]# service postgresql-9.4 stop</code></pre>
</div>
</div>
<div class="paragraph">
<p>On RHEL/CentOS 7:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv01 ~]# systemctl stop postgresql-9.4</code></pre>
</div>
</div>
<div class="paragraph">
<p>That will stop the <em>PostgreSQL</em> on the primary/master server.
That means, <em>pgpool-II</em> should automatically execute the <code>failover.sh</code> script, that will promote the standby server as the new master.</p>
</div>
<div class="paragraph">
<p>In other words, our setup becomes like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/pgpool-sql-failover.png" alt="pgpool sql failover">
</div>
</div>
<div class="paragraph">
<p>Result on <em>pgpool-II</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">|---
[root@onmssrv01 ~]# psql -U pgpool -h onmssrv01 -p 9999 -d postgres -c "show pool_nodes"
Password for user pgpool:
 node_id | hostname  | port | status | lb_weight |  role
---------+-----------+------+--------+-----------+---------
 0       | pgdbsrv01 | 5432 | 3      | 0.500000  | standby
 1       | pgdbsrv02 | 5432 | 2      | 0.500000  | primary
(2 rows)
|---</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see that the former slave (<em>pgdbsrv02</em>) has now became the primary, and the former primary (<em>pgdbsrv01</em>) has now become a standby but has an offline status (<em>3</em>).</p>
</div>
<div class="paragraph">
<p>Result in <em>repmgr</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv02 ~]# su - postgres -c " /usr/pgsql-9.4/bin/repmgr -f /etc/repmgr/9.4/repmgr.conf cluster show"
[2015-07-13 13:58:27] [INFO] connecting to database
Role      | Connection String
[2015-07-13 13:58:27] [ERROR] connection to database failed: could not connect to server: Connection refused
	Is the server running on host "pgdbsrv01" (192.168.205.163) and accepting
	TCP/IP connections on port 5432?

  FAILED  | host=pgdbsrv01 user=repmgr dbname=repmgr
* master  | host=pgdbsrv02 user=repmgr dbname=repmgr</code></pre>
</div>
</div>
<div class="paragraph">
<p>The failover script should add some useful information to <code>/var/log/pgpool/pgpool_failover.log</code>, when a failover happens:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@onmssrv01 ~]# cat /var/log/pgpool/pgpool_failover.log
Wed Jul 29 19:02:49 UTC 2015
Failed node: pgdbsrv01, Promoting pgdbsrv02 ...
+ /usr/bin/ssh -T -l postgres pgdbsrv02 '/usr/pgsql-9.4/bin/repmgr -f /etc/repmgr/9.4/repmgr.conf standby promote 2&gt;/dev/null 1&gt;/dev/null &lt;&amp;-'
+ exit 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, the database stays available via <em>pgpool-II</em> and the former standby became read-write.</p>
</div>
</div>
<div class="sect2">
<h3 id="_recover_after_failover_to_a_master_slave_situation">Recover after failover to a master-slave situation</h3>
<div class="paragraph">
<p>After the failover, you end up in a working, non-redundant situation.
Everything keeps working for users of the database but it would be good to go back to a primary-standby configuration.
The goal is to get to this setup:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/pgpool-sql-recover.png" alt="pgpool sql recover">
</div>
</div>
<div class="paragraph">
<p>The first step in this process is to investigate why the primary DB became unavailable and resolve that problem.
Once you’re sure that the host (<em>pgdbsrv01</em> in our example) is healthy again, we can start using that host as the new standby-server.</p>
</div>
<div class="paragraph">
<p>First, make sure that the database on <em>pgdbsrv01</em> isn’t started:</p>
</div>
<div class="paragraph">
<p>On <em>RHEL/CentOS 6</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv01 ~]# service postgresql-9.4 stop</code></pre>
</div>
</div>
<div class="paragraph">
<p>On <em>RHEL/CentOS 7</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv01 ~]# systemctl stop postgresql-9.4</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, we’ll sync the data of <em>pgdbsrv02</em> (the current primary) to the previously failed node (<em>pgdbsrv01</em>).
In the meanwhile, the database has got some updates and changes so we need to make sure that those get replicated to <em>pgdbsrv011</em> before we start it as a standby.</p>
</div>
<div class="paragraph">
<p>There are two way to perform the sync operation:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Perform a full synchronization, in other words, recreate the whole <code>/var/lib/pgsql/9.4/data</code> directory from scratch:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv01 ~]# su - postgres
-bash-4.1$ rm -rf 9.4/data/
-bash-4.1$ /usr/pgsql-9.4/bin/repmgr -f /etc/repmgr/9.4/repmgr.conf --verbose -D /var/lib/pgsql/9.4/data -d repmgr -p 5432 -U repmgr -R postgres standby clone pgdbsrv02
[2015-07-13 17:26:19] [NOTICE] opening configuration file: /etc/repmgr/9.4/repmgr.conf
[2015-07-13 17:26:19] [NOTICE] destination directory '/var/lib/pgsql/9.4/data' provided
[2015-07-13 17:26:19] [INFO] connecting to upstream node
[2015-07-13 17:26:19] [INFO] connected to upstream node, checking its state
[2015-07-13 17:26:19] [INFO] Successfully connected to upstream node. Current installation size is 39 MB
[2015-07-13 17:26:19] [NOTICE] starting backup...
[2015-07-13 17:26:19] [INFO] creating directory "/var/lib/pgsql/9.4/data"...
[2015-07-13 17:26:19] [INFO] executing: '/usr/pgsql-9.4/bin/pg_basebackup -l "repmgr base backup"  -h pgdbsrv02 -p 5432 -U repmgr -D /var/lib/pgsql/9.4/data --xlog-method=stream'
[2015-07-13 17:26:22] [NOTICE] standby clone (using pg_basebackup) complete
[2015-07-13 17:26:22] [NOTICE] HINT: you can now start your PostgreSQL server
[2015-07-13 17:26:22] [NOTICE] for example : pg_ctl -D /var/lib/pgsql/9.4/data start</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
if the command execution ask for the password configured for the repmgr user, execute the restorecon command to avoid SELinux issues when it is enforcing.
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Perform a partial synchronization which can be a lot faster than the first procedure, to synchronize only the things that have been changed during the outage on the DB server, which assumes the data directory exist and it is not corrupted. If you’re not sure about the state of the data directory, use the first procedure:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv01 ~]# su - postgres
-bash-4.1$ /usr/pgsql-9.4/bin/repmgr -f /etc/repmgr/9.4/repmgr.conf --verbose --force --rsync-only -D /var/lib/pgsql/9.4/data -d repmgr -p 5432 -U repmgr -R postgres standby clone pgdbsrv02
[2015-07-13 17:25:17] [NOTICE] opening configuration file: /etc/repmgr/9.4/repmgr.conf
[2015-07-13 17:25:17] [NOTICE] destination directory '/var/lib/pgsql/9.4/data' provided
[2015-07-13 17:25:17] [INFO] connecting to upstream node
[2015-07-13 17:25:17] [INFO] connected to upstream node, checking its state
[2015-07-13 17:25:17] [INFO] Successfully connected to upstream node. Current installation size is 39 MB
[2015-07-13 17:25:17] [NOTICE] starting backup...
[2015-07-13 17:25:17] [WARNING] directory "/var/lib/pgsql/9.4/data" exists but is not empty
[2015-07-13 17:25:22] [INFO] standby clone: master data directory '/var/lib/pgsql/9.4/data'
[2015-07-13 17:25:22] [INFO] rsync command line: 'rsync --archive --checksum --compress --progress --rsh=ssh --delete --checksum --exclude=postmaster.pid --exclude=postmaster.opts --exclude=global/pg_control --exclude=postgresql.auto.conf.tmp --exclude=pgsql_tmp* --exclude=pg_xlog/* --exclude=pg_log/* --exclude=pg_stat_tmp/* --exclude=pg_replslot/* postgres@pgdbsrv02:/var/lib/pgsql/9.4/data/* /var/lib/pgsql/9.4/data'
receiving incremental file list
...
total size is 41881588  speedup is 238.68
[2015-07-13 17:25:22] [INFO] standby clone: local control file '/var/lib/pgsql/9.4/data/global'
[2015-07-13 17:25:22] [INFO] standby clone: master control file '/var/lib/pgsql/9.4/data/global/pg_control'
[2015-07-13 17:25:22] [INFO] rsync command line: 'rsync --archive --checksum --compress --progress --rsh=ssh --delete --checksum postgres@pgdbsrv02:/var/lib/pgsql/9.4/data/global/pg_control /var/lib/pgsql/9.4/data/global'
receiving incremental file list
pg_control
        8192 100%    7.81MB/s    0:00:00 (xfer#1, to-check=0/1)

sent 102 bytes  received 244 bytes  692.00 bytes/sec
total size is 8192  speedup is 23.68
[2015-07-13 17:25:22] [NOTICE] notifying master about backup completion...
NOTICE:  pg_stop_backup complete, all required WAL segments have been archived
[2015-07-13 17:25:23] [NOTICE] standby clone (using rsync) complete
[2015-07-13 17:25:23] [NOTICE] HINT: you can now start your PostgreSQL server
[2015-07-13 17:25:23] [NOTICE] for example : pg_ctl -D /var/lib/pgsql/9.4/data start</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the command is basically the same, the only change is the addition of the <code>--rsync-only</code> option.</p>
</div>
<div class="paragraph">
<p>At this point, the data is (more or less) in sync with the current primary on <em>pgdbsrv02</em>, so let’s start <em>pgdbsrv01</em> to act as the standby:</p>
</div>
<div class="paragraph">
<p>On <em>RHEL/CentOS 6</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv01 ~]# service postgresql-9.4 start</code></pre>
</div>
</div>
<div class="paragraph">
<p>On <em>RHEL/CentOS 7</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv01 ~]# systemctl start postgresql-9.4</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Repmgr</em> notices automatically that the new standby got available:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv01 ~]# sudo su - postgres -c " /usr/pgsql-9.4/bin/repmgr -f /etc/repmgr/9.4/repmgr.conf cluster show"
Role       | Connection String
   standby | host=pgdbsrv1 user=repmgr dbname=repmgr
 * master  | host=pgdbsrv2 user=repmgr dbname=repmgr</code></pre>
</div>
</div>
<div class="paragraph">
<p>For <em>pgpool-II</em>, we need to re-attach the failed node in order for it to be visible and usable as a standby-node:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">|----
[root@onmssrv01 ~]# pcp_attach_node 0 localhost 9898 postgres postgres 0
[root@onmssrv01 ~]# psql -U pgpool -h onmssrv01 -p 9999 -d postgres -c "show pool_nodes"
Password for user pgpool:
 node_id | hostname | port | status | lb_weight |  role
---------+----------+------+--------+-----------+---------
 0       | pgdbsrv01 | 5432 | 2      | 0.500000  | standby
 1       | pgdbsrv02 | 5432 | 2      | 0.500000  | primary
(2 rows)
|----</code></pre>
</div>
</div>
<div class="paragraph">
<p>For the <code>pcp_attach_node</code> command, it is required to use the authentication credentials defined on /etc/pgpool-II/pcp.conf. Also, it is required to know the node_id of the node you want to re-attach. The "show pool_nodes" will give you all the information (including the <code>node_id</code>).
In this case the <em>ID</em> for <em>pgdbsrv01</em> is <code>0</code>.</p>
</div>
<div class="paragraph">
<p>At this point, we’re back in a redundant status where the old standby (<em>pgdbsrv02</em>) functions as the primary and the old primary (<em>pgdbsrv01</em>) functions as a standby.
If both machines are equal, you can leave the situation as is and continue to use it in this way.</p>
</div>
</div>
<div class="sect2">
<h3 id="_recover_to_the_original_situation">Recover to the original situation</h3>
<div class="paragraph">
<p>This is completely optional and not required.
Be sure that <em>pgpool-II</em> is running on one of the <em>OpenNMS</em> servers before proceed.</p>
</div>
<div class="paragraph">
<p>In case you want to go back to the initial setup ( <em>pgdbsrv01</em> as primary, <em>pgdbsrv02</em> as standby), you can initiate a manual failover by stopping the current new primary ( <em>pgdbsrv02</em> )  and recover it to use as a standby:</p>
</div>
<div class="paragraph">
<p>On <em>RHEL/CentOS 6</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv02 ~]# service postgresql-9.4 stop</code></pre>
</div>
</div>
<div class="paragraph">
<p>On <em>RHEL/CentOS 7</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv02 ~]# systemctl stop postgresql-9.4</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the master ( <em>pgdbsrv02</em> ) stopped, a failover is triggered and <em>pgdbsrv01</em> gets assigned as primary again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">|----
[root@onmssrv01 ~]# psql -U pgpool -h onmssrv01 -p 9999 -d postgres -c "show pool_nodes"
Password for user pgpool:
 node_id | hostname  | port | status | lb_weight |  role
---------+-----------+------+--------+-----------+---------
 0       | pgdbsrv01 | 5432 | 2      | 0.500000  | primary
 1       | pgdbsrv02 | 5432 | 3      | 0.500000  | standby
(2 rows)
|----</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, sync <em>pgdbsrv02</em> with the new primary ( <em>pgdbsrv01</em> ) and start it (this time, use <code>--rsync-only</code> as this is an intentional action and the data directory is not corrupted):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv02 ~]# sudo su - postgres
-bash-4.2$ /usr/pgsql-9.4/bin/repmgr -f /etc/repmgr/9.4/repmgr.conf --verbose --force --rsync-only -D /var/lib/pgsql/9.4/data -d repmgr -p 5432 -U repmgr -R postgres standby clone pgdbsrv01</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, start the <em>postgresql-9.4</em> service.</p>
</div>
<div class="paragraph">
<p>On <em>RHEL/CentOS 6</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv02 ~]# service postgresql-9.4 start</code></pre>
</div>
</div>
<div class="paragraph">
<p>On <em>RHEL/CentOS 7</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv02 ~]# systemctl start postgresql-9.4</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, Re-attach <em>pgdbsrv02</em> to <em>pgpool-II</em> in order to use it as a slave:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">|----
[root@onmssrv01 ~]# pcp_attach_node 0 localhost 9898 postgres postgres 1
[root@onmssrv01 ~]# psql -U pgpool -h onmssrv01 -p 9999 -d postgres -c "show pool_nodes"
 node_id | hostname | port | status | lb_weight |  role
---------+----------+------+--------+-----------+---------
 0       | pgdbsrv01| 5432 | 2      | 0.500000  | primary
 1       | pgdbsrv02| 5432 | 2      | 0.500000  | standby
(2 rows)
|----</code></pre>
</div>
</div>
<div class="paragraph">
<p>After going trough all of the above steps, we’re back to the initial situation where <em>pgdbsrv01</em> acts as the primary and <em>pgdbsrv02</em> acts as the standby.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
When you’re done testing <em>pgpool-II</em>, remember to stop the service on the <em>OpenNMS</em> server where it is running.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_recover_to_the_original_situation_2">Recover to the original situation</h3>
<div class="paragraph">
<p>This is completely optional and not required.
Be sure that <em>pgpool-II</em> is running on one of the <em>OpenNMS</em> servers before proceed.</p>
</div>
<div class="paragraph">
<p>In case you want to go back to the initial setup ( <em>pgdbsrv01</em> as primary, <em>pgdbsrv02</em> as standby), you can initiate a manual failover by stopping the current new primary ( <em>pgdbsrv02</em> ) and recover it to use as a standby:</p>
</div>
<div class="paragraph">
<p>On <em>RHEL/CentOS 6</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv02 ~]# service postgresql-9.4 stop</code></pre>
</div>
</div>
<div class="paragraph">
<p>On <em>RHEL/CentOS 7</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv02 ~]# systemctl stop postgresql-9.4</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the master ( <em>pgdbsrv02</em> ) stopped, a failover is triggered and <em>pgdbsrv01</em> gets assigned as primary again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">|----
[root@onmssrv01 ~]# psql -U pgpool -h onmssrv01 -p 9999 -d postgres -c "show pool_nodes"
Password for user pgpool:
 node_id | hostname  | port | status | lb_weight |  role
---------+-----------+------+--------+-----------+---------
 0       | pgdbsrv01 | 5432 | 2      | 0.500000  | primary
 1       | pgdbsrv02 | 5432 | 3      | 0.500000  | standby
(2 rows)
|----</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, sync <em>pgdbsrv02</em> with the new primary ( <em>pgdbsrv01</em> ) and start it (this time, use <code>--rsync-only</code> as this is an intentional action and the data directory is not corrupted):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv02 ~]# sudo su - postgres
-bash-4.2$ /usr/pgsql-9.4/bin/repmgr -f /etc/repmgr/9.4/repmgr.conf --verbose --force --rsync-only -D /var/lib/pgsql/9.4/data -d repmgr -p 5432 -U repmgr -R postgres standby clone pgdbsrv01</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, start the <em>postgresql-9.4</em> service.</p>
</div>
<div class="paragraph">
<p>On <em>RHEL/CentOS 6</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv02 ~]# service postgresql-9.4 start</code></pre>
</div>
</div>
<div class="paragraph">
<p>On <em>RHEL/CentOS 7</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">[root@pgdbsrv02 ~]# systemctl start postgresql-9.4</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, Re-attach <em>pgdbsrv02</em> to <em>pgpool-II</em> in order to use it as a slave:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">|----
[root@onmssrv01 ~]# pcp_attach_node 0 localhost 9898 postgres postgres 1
[root@onmssrv01 ~]# psql -U pgpool -h onmssrv01 -p 9999 -d postgres -c "show pool_nodes"
 node_id | hostname | port | status | lb_weight |  role
---------+----------+------+--------+-----------+---------
 0       | pgdbsrv01| 5432 | 2      | 0.500000  | primary
 1       | pgdbsrv02| 5432 | 2      | 0.500000  | standby
(2 rows)
|----</code></pre>
</div>
</div>
<div class="paragraph">
<p>After going trough all of the above steps, we’re back to the initial situation where <em>pgdbsrv01</em> acts as the primary and <em>pgdbsrv02</em> acts as the standby.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
When you’re done testing <em>pgpool-II</em>, remember to stop the service on the <em>OpenNMS</em> server where it is running.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_troubleshooting">Troubleshooting</h3>
<div class="paragraph">
<p>In case you have trouble starting the <em>pgpool</em> service, be sure that it is not running on the other <em>OpenNMS</em> machine, and also that the socket files (i.e. <code>/tmp/.s.PGSQL.9898</code> and <code>/tmp/.s.PGSQL.9999</code>) don’t exist.
If they exist, remove them prior start.
In theory this cleanup is always performed by the <em>pgpool</em> initialization script, but it is important to understand why.</p>
</div>
<div class="paragraph">
<p>The cleanup is performed through the script located at <code>/usr/local/bin/dbcleanup.sh</code> as mentioned on an earlier section.
The reason to have this integrated with the <em>pgpool</em> initialization script is to be sure that <em>OpenNMS</em> will be able to initialize the <em>DB Connection Pool</em> without issues.
Because of this, prior every single start request of the <em>OpenNMS</em> application (either manually or through the cluster), <em>pgpool</em> must be restarted first.
As an alternative, prior starting <em>OpenNMS</em>, execute the <code>dbcleanup.sh</code> script to be sure that there are no connections against the <em>DB</em> servers when <em>OpenNMS</em> starts.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2015-08-03 13:17:10 CEST
</div>
</div>
</body>
</html>